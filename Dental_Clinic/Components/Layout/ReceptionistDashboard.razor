@page "/receptionist/dashboard"
@using Microsoft.AspNetCore.Components.Routing
@using Dental_Clinic.Components.Receptionist
@using Dental_Clinic.Services
@using Dental_Clinic.Models
@inject NavigationManager Navigation
@inject AppointmentService AppointmentService
@inherits LayoutComponentBase
<link href="css/receptionistdashboard.css" rel="stylesheet" />

<div class="receptionist-dashboard">
    <ReceptNavBar />

    @if (Body is null)
    {
        <!-- Main Content (Dashboard) -->
        <main class="dashboard-main">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-header"><p class="stat-label">Today's Appointments</p><div class="stat-icon blue"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg></div></div><h3 class="stat-value">@TodayAppointmentsCount</h3>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><p class="stat-label">In Waiting Room</p><div class="stat-icon yellow"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg></div></div><h3 class="stat-value">@InWaitingRoomCount</h3>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><p class="stat-label">In Progress</p><div class="stat-icon green"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div></div><h3 class="stat-value">@InProgressCount</h3>
                </div>
                <div class="stat-card">
                    <div class="stat-header"><p class="stat-label">Confirmed Today</p><div class="stat-icon cyan"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg></div></div><h3 class="stat-value">@ConfirmedTodayCount</h3>
                </div>
            </div>

            <section class="quick-actions-section">
                <div class="section-header-simple"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg><h3>Quick Actions</h3></div>
                <QuickActions />
            </section>

            <section class="appointments-section">
                <div class="section-header-appointments"><div class="section-title-group"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg><h3>Today's Appointments</h3></div><span class="section-date">@DateTime.Now.ToString("dddd, MMMM dd, yyyy")</span></div>
                <div class="appointments-list">
                    @if (TodayAppointments == null)
                    {
                        <p>Loading appointments...</p>
                    }
                    else if (!TodayAppointments.Any())
                    {
                        <p>No appointments for today.</p>
                    }
                    else
                    {
                        @foreach (var appointment in TodayAppointments)
                        {
                            <div class="appointment-card">
                                <div class="appointment-time"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span>@(appointment.StartTime.HasValue ? DateTime.Today.Add(appointment.StartTime.Value).ToString("h:mm tt") : "N/A")</span></div>
                                <div class="appointment-details">
                                    <div class="appointment-header">
                                        <div style="display: flex; align-items: center; gap: 8px;">
                                            @if (!string.IsNullOrEmpty(appointment.PatientAvatar))
                                            {
                                                <img src="@appointment.PatientAvatar" style="width: 32px; height: 32px; border-radius: 50%; object-fit: cover;" />
                                            }
                                            <h4 class="patient-name">@appointment.PatientName</h4>
                                        </div>
                                        <span class="status-badge @GetStatusClass(appointment.Status)">@appointment.Status</span>
                                    </div>
                                    <p class="appointment-service">@appointment.ServiceName</p>
                                    <div class="appointment-meta">
                                        <div class="meta-item"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg><span>@appointment.DentistName</span></div>
                                        <div class="meta-item"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg><span>@appointment.PatientPhone</span></div>
                                        <div class="meta-item"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg><span>@(appointment.EndTime.HasValue && appointment.StartTime.HasValue ? (appointment.EndTime.Value - appointment.StartTime.Value).TotalMinutes : 0) min</span></div>
                                    </div>
                                </div>
                                <button class="action-icon-btn"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path></svg></button>
                            </div>
                        }
                    }
                </div>
            </section>
        </main>
    }
    else
    {
        @Body
    }

</div>

@code {
    private List<Appointment> TodayAppointments;
    private int TodayAppointmentsCount;
    private int InWaitingRoomCount;
    private int InProgressCount;
    private int ConfirmedTodayCount;

    protected override async Task OnInitializedAsync()
    {
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        TodayAppointments = await AppointmentService.GetAppointmentsInRangeAsync(DateTime.Today, DateTime.Today);
        TodayAppointmentsCount = TodayAppointments.Count;
        InWaitingRoomCount = TodayAppointments.Count(a => a.Status == "Waiting");
        InProgressCount = TodayAppointments.Count(a => a.Status == "In Progress");
        ConfirmedTodayCount = TodayAppointments.Count(a => a.Status == "Confirmed");
    }

    private string GetStatusClass(string status)
    {
        return status?.ToLower() switch
        {
            "waiting" => "waiting",
            "in progress" => "in-progress",
            "confirmed" => "confirmed",
            "completed" => "completed",
            "cancelled" => "cancelled",
            _ => ""
        };
    }
}