@page "/admin-dashboard"
@using Microsoft.AspNetCore.Components.Routing
@using Microsoft.AspNetCore.Components
@using Microsoft.AspNetCore.Components.Web
@inject NavigationManager Navigation
@inject Dental_Clinic.Services.DatabaseService DatabaseService
@inject Dental_Clinic.Services.SessionService SessionService

<link rel="stylesheet" href="css/admindashboard.css" />

<div class="dashboard-page">
    <AdminNavBar />

    <!-- Main Content -->
    <main class="dashboard-main">
        <!-- Hero Welcome Banner -->
        <section class="hero-banner">
            <div class="hero-content">
                <h1 class="hero-title">Welcome back, Dr. Admin!</h1>
                <p class="hero-subtitle">Here's what's happening at Aurelia Dental Clinic - Dr Jade today</p>
            </div>
            <div class="hero-shield-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M12 22C12 22 20 18 20 12V5L12 2L4 5V12C4 18 12 22 12 22Z" stroke="white" stroke-width="1.5"
                        stroke-linecap="round" stroke-linejoin="round" fill="rgba(255,255,255,0.1)" />
                </svg>
            </div>
        </section>

        <!-- Stats Cards Grid -->
        <section class="stats-grid">
            <!-- Total Revenue Card -->
            <div class="stat-card revenue-card">
                <div class="stat-icon-wrapper revenue-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 2V22M17 5H9.5C8.57174 5 7.6815 5.36875 7.02513 6.02513C6.36875 6.6815 6 7.57174 6 8.5C6 9.42826 6.36875 10.3185 7.02513 10.9749C7.6815 11.6313 8.57174 12 9.5 12H14.5C15.4283 12 16.3185 12.3687 16.9749 13.0251C17.6313 13.6815 18 14.5717 18 15.5C18 16.4283 17.6313 17.3185 16.9749 17.9749C16.3185 18.6313 15.4283 19 14.5 19H6"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="stat-details">
                    <div class="stat-label">Total Revenue</div>
                    <div class="stat-value">@TotalRevenue.ToString("C0")</div>
                    <div class="stat-trend positive">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9L6 3M6 3L3 6M6 3L9 6" stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        +12.5%
                    </div>
                </div>
            </div>

            <!-- Total Patients Card -->
            <div class="stat-card patients-card">
                <div class="stat-icon-wrapper patients-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M17 21V19C17 17.9391 16.5786 16.9217 15.8284 16.1716C15.0783 15.4214 14.0609 15 13 15H5C3.93913 15 2.92172 15.4214 2.17157 16.1716C1.42143 16.9217 1 17.9391 1 19V21"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path
                            d="M9 11C11.2091 11 13 9.20914 13 7C13 4.79086 11.2091 3 9 3C6.79086 3 5 4.79086 5 7C5 9.20914 6.79086 11 9 11Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path
                            d="M23 21V19C22.9993 18.1137 22.7044 17.2528 22.1614 16.5523C21.6184 15.8519 20.8581 15.3516 20 15.13"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path
                            d="M16 3.13C16.8604 3.3503 17.623 3.8507 18.1676 4.55231C18.7122 5.25392 19.0078 6.11683 19.0078 7.005C19.0078 7.89317 18.7122 8.75608 18.1676 9.45769C17.623 10.1593 16.8604 10.6597 16 10.88"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="stat-details">
                    <div class="stat-label">Total Patients</div>
                    <div class="stat-value">@TotalPatients</div>
                    <div class="stat-trend positive">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9L6 3M6 3L3 6M6 3L9 6" stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        +156 new
                    </div>
                </div>
            </div>

            <!-- Appointments Card -->
            <div class="stat-card appointments-card">
                <div class="stat-icon-wrapper appointments-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="stat-details">
                    <div class="stat-label">Appointments</div>
                    <div class="stat-value">@TotalAppointments</div>
                    <div class="stat-trend positive">
                        <svg width="12" height="12" viewBox="0 0 12 12" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 9L6 3M6 3L3 6M6 3L9 6" stroke="currentColor" stroke-width="1.5"
                                stroke-linecap="round" stroke-linejoin="round" />
                        </svg>
                        +8.3%
                    </div>
                </div>
            </div>

            <!-- Average Rating Card -->
            <div class="stat-card rating-card">
                <div class="stat-icon-wrapper rating-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M12 2L15.09 8.26L22 9.27L17 14.14L18.18 21.02L12 17.77L5.82 21.02L7 14.14L2 9.27L8.91 8.26L12 2Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                </div>
                <div class="stat-details">
                    <div class="stat-label">Avg Rating</div>
                    <div class="stat-value">4.8</div>
                    <div class="stat-info">95% satisfaction</div>
                </div>
            </div>
        </section>

        <!-- Charts Section -->
        <section class="charts-section">
            <!-- Monthly Revenue Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Revenue Analytics</h3>
                    <select class="chart-period-select" @onchange="OnRevenuePeriodChanged" value="@RevenuePeriod">
                        <option value="Monthly">Monthly (Last 6)</option>
                        <option value="Weekly">Weekly (Last 8)</option>
                    </select>
                </div>
                <div class="chart-body">
                    <div class="chart-placeholder bar-chart-placeholder">
                        <div class="bars-container">
                            @if (MonthlyRevenue.Any())
                            {
                                @foreach (var item in MonthlyRevenue)
                                {
                                    <div class="bar-wrapper" title="@item.Revenue.ToString("C0")">
                                        <div class="bar" style="height: @GetBarHeight(item.Revenue);"></div>
                                        <span class="bar-label">@item.Month</span>
                                    </div>
                                }
                            }
                            else
                            {
                                <div class="no-data">No revenue data available</div>
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Service Distribution Chart -->
            <div class="chart-card">
                <div class="chart-header">
                    <h3>Service Distribution</h3>
                </div>
                <div class="chart-body">
                    <div class="chart-placeholder pie-chart-layout">
                        @if (ServiceDistribution.Any())
                        {
                            <div class="pie-chart-circle">
                                <svg width="200" height="200" viewBox="0 0 200 200">
                                    @for (int i = 0; i < ServiceDistribution.Count; i++)
                                    {
                                        var item = ServiceDistribution[i];
                                        var color = GetPieColor(i);
                                        var dashArray = GetDashArray(item.Count);
                                        var dashOffset = GetDashOffset(i);

                                        <circle cx="100" cy="100" r="70" fill="none" stroke="@color" stroke-width="60"
                                            stroke-dasharray="@dashArray 440" stroke-dashoffset="@dashOffset"
                                            transform="rotate(-90 100 100)" />
                                    }
                                </svg>
                            </div>
                            <div class="pie-legend">
                                @for (int i = 0; i < ServiceDistribution.Count; i++)
                                {
                                    var item = ServiceDistribution[i];
                                    var color = GetPieColor(i);
                                    <div class="legend-item">
                                        <span class="legend-dot" style="background: @color;"></span>
                                        <span class="legend-text">@item.ServiceName (@GetPercentage(item.Count))</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="no-data">No service data available</div>
                        }
                    </div>
                </div>
            </div>
        </section>
    </main>
</div>

@code {
    private decimal TotalRevenue;
    private int TotalPatients;
    private int TotalAppointments;
    private List<(string Month, decimal Revenue)> MonthlyRevenue = new();
    private List<(string ServiceName, int Count)> ServiceDistribution = new();
    private string userAvatar;
    private string userName = "Administrator";
    private string userRole = "Administrator";

    // For charts
    private decimal MaxRevenue => MonthlyRevenue.Any() ? MonthlyRevenue.Max(m => m.Revenue) : 1;
    private int TotalServiceCount => ServiceDistribution.Sum(s => s.Count);

    // Colors for pie chart
    private string[] PieColors = new[] { "#0EA5E9", "#10B981", "#06B6D4", "#F59E0B", "#EF4444", "#94A3B8", "#8B5CF6",
"#EC4899" };

    private string RevenuePeriod = "Monthly";

    protected override async Task OnInitializedAsync()
    {
        var session = await SessionService.GetCurrentSessionAsync();
        if (session != null && session.UserId != 0)
        {
            var user = await DatabaseService.GetUserByIdAsync(session.UserId);
            if (user != null)
            {
                userAvatar = user.Avatar;
                userName = $"{user.FirstName} {user.LastName}";
                userRole = user.RoleName;
            }
        }
        await LoadDashboardData();
    }

    private async Task LoadDashboardData()
    {
        TotalRevenue = await DatabaseService.GetTotalRevenueAsync();
        TotalPatients = await DatabaseService.GetTotalPatientsAsync();
        TotalAppointments = await DatabaseService.GetTotalAppointmentsAsync();

        await LoadRevenueData();

        var serviceData = await DatabaseService.GetServiceDistributionAsync();
        ServiceDistribution = serviceData.Select(x => (x.Key, x.Value)).ToList();
    }

    private async Task OnRevenuePeriodChanged(ChangeEventArgs e)
    {
        RevenuePeriod = e.Value?.ToString() ?? "Monthly";
        await LoadRevenueData();
    }

    private async Task LoadRevenueData()
    {
        if (RevenuePeriod == "Monthly")
        {
            var data = await DatabaseService.GetMonthlyRevenueAsync(6);
            MonthlyRevenue = data.Select(x => (x.Key, x.Value)).ToList();
        }
        else
        {
            var data = await DatabaseService.GetWeeklyRevenueAsync(8);
            MonthlyRevenue = data.Select(x => (x.Key, x.Value)).ToList();
        }
    }

    private string GetBarHeight(decimal revenue)
    {
        if (MaxRevenue == 0) return "0%";
        var percentage = (revenue / MaxRevenue) * 100;
        // Ensure at least a small bar is visible if there is revenue
        if (percentage > 0 && percentage < 5) percentage = 5;
        return $"{percentage}%";
    }

    private double GetDashArray(int count)
    {
        if (TotalServiceCount == 0) return 0;
        // Circumference is approx 440 for r=70 (2 * PI * 70 = 439.82)
        return ((double)count / TotalServiceCount) * 439.82;
    }

    private double GetDashOffset(int index)
    {
        if (index == 0) return 0;
        double offset = 0;
        for (int i = 0; i < index; i++)
        {
            offset += GetDashArray(ServiceDistribution[i].Count);
        }
        return -offset;
    }

    private string GetPieColor(int index)
    {
        return PieColors[index % PieColors.Length];
    }

    private string GetPercentage(int count)
    {
        if (TotalServiceCount == 0) return "0%";
        return $"{((double)count / TotalServiceCount * 100):F1}%";
    }
}