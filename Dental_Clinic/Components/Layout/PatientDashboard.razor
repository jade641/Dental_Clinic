@page "/dashboard"
@using System.Diagnostics
@inject Dental_Clinic.Services.SessionService SessionService
@inject NavigationManager Navigation

<div class="dashboard-page">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                <div class="navbar-logo">
                    <img src="css/bootstrap/Dental_Logo.png" alt="Aurelia Dental Logo" />
                </div>
                <div class="navbar-brand-text">
                    <h1>AURELIA DENTAL CLINIC</h1>
                    <p>YOUR SMILE. OUR MASTERPIECE</p>
                </div>
            </a>

            <div class="navbar-menu">
                <ul class="nav-links">
                    <li>
                        <a href="/dashboard" class="nav-link active">
                            <svg width="16" height="16" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M39l9-797v11a22001-22H5a22001-2-2z"></path>
                                <polyline points="92291215121522"></polyline>
                            </svg>
                            Overview
                        </a>
                    </li>
                    <li>
                        <a href="/appointments" class="nav-link">
                            <svg width="16" height="16" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Appointments
                        </a>
                    </li>
                    <li>
                        <a href="/history" class="nav-link">
                            <svg width="16" height="16" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M142H6a22000-22v16a2200022h12a220002-2V8z"></path>
                                <polyline points="142148208"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="1099989"></polyline>
                            </svg>
                            History
                        </a>
                    </li>
                    <li>
                        <a href="/billing" class="nav-link">
                            <svg width="16" height="16" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Billing
                        </a>
                    </li>
                </ul>

                <div class="navbar-actions">
                    <div class="search-box">
                        <svg class="search-icon" width="16" height="16" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m2121-4.35-4.35"></path>
                        </svg>
                        <input type="text" placeholder="Search services, appointments..." />
                    </div>

                    <button class="notification-btn">
                        <svg width="20" height="20" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M188A6600068c07-39-39h18s-3-2-3-9"></path>
                            <path d="M13.7321a22001-3.460"></path>
                        </svg>
                        <span class="notification-badge">2</span>
                    </button>

                    <button class="settings-btn" title="Settings" aria-label="Open settings">
          <span class="settings-icon">
    <svg width="20" height="20" viewBox="002424" fill="none" xmlns="http://www.w3.org/2000/svg">
  <path d="M1215C13.6569151513.65691512C1510.343113.65699129C10.34319910.3431912C913.656910.3431151215Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
   <path d="M19.415C19.266915.301619.227215.636219.28615.9606C19.344816.28519.499516.584319.7316.82L19.7916.88C19.97617.065720.123517.286320.224117.5291C20.324817.771920.376618.032220.376618.295C20.376618.557820.324818.818120.224119.0609C20.123519.303719.97619.524319.7919.71C19.604319.89619.383720.043519.140920.1441C18.898120.244818.637820.296618.37520.2966C18.112220.296617.851920.244817.609120.1441C17.366320.043517.145719.89616.9619.71L16.919.65C16.664319.419516.36519.264816.040619.206C15.716219.147215.381619.186915.0819.32C14.784219.446814.53219.657214.354319.9255C14.176620.193814.081320.508214.0820.83V21C14.0821.530413.869322.039113.494222.4142C13.119122.789312.61042312.0823C11.54961.2107111.04091.5857910.6658C1.9608610.29072.4695710.08310.08H3.09C3.4209910.07233.7429.965124.01139.77251C4.280599.57994.485729.310744.69C4.733128.698384.772828.363814.7148.03941C4.655197.715024.500547.415684.277.18L4.217.12C4.024056.934253.876536.713683.775886.47088C3.675236.228083.623435.967833.623435.705C3.623431.442173.675235.181923.775884.93912C3.876534.696324.024054.475754.214.29C4.395754.104054.616323.956534.859123.85588C5.101923.755235.362173.703435.6253.70343C5.887833.703436.148083.755236.390883.85588C6.633683.956536.854254.104057.044.29L7.14.35C7.335684.580547.635024.735197.959414.794C8.283814.852828.618384.813128.924.68H9C9.295774.553249.548024.342769.725694.07447C9.903373.806189.998723.49179103.17V3C102.4695710.21071.9608610.58581.58579C10.96091.2107111.46961121C12.5304113.03911.2107113.41421.58579C13.78931.96086142.46957143V3.09C14.00133.4117914.09663.7261814.27433.99447C14.4524.2627614.70424.47324154.6C15.30164.7331215.63624.7728215.96064.714C16.2854.6551916.58434.5005416.824.27L16.884.21C17.06574.0240517.28633.8765317.52913.77588C17.77193.6752318.03223.6234318.2953.62343C18.55783.6234318.81813.6752319.06093.77588C19.30373.8765319.52434.0240519.714.21C19.8964.3957520.04354.6163220.14414.85912C20.24485.1019220.29665.3621720.29665.625C20.29665.8878320.24486.1480820.14416.39088C20.04356.6336819.8966.8542519.717.04L19.657.1C19.41957.3356819.26487.6350219.2067.95941C19.14728.2838119.18698.6183819.328.92V9C19.44689.2957719.65729.5480219.92559.72569C20.19389.9033720.50829.9987220.8310H21C21.53041022.039110.210722.414210.5858C22.789310.96092311.46962312C2312.530422.789313.039122.414213.4142C22.039113.789321.5304142114H20.91C20.588214.001320.273814.096620.005514.2743C19.737214.45219.526814.704219.415Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
             </svg>
        </span>
        </button>

                    <div class="user-profile">
                        <div class="user-avatar">@patientName.Substring(0,1).ToUpper()</div>
                        <div class="user-info">
                            <div class="user-name">@patientName</div>
                            <div class="user-role">Patient Portal</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-inner">
        <!-- Hero / Greeting -->
        <section class="hero-card">
            <div class="hero-content">
                <h1>Good morning, <span>@(string.IsNullOrWhiteSpace(patientName) ? "Patient" : patientName)</span>!</h1>
                <p class="muted">Welcome to your AURELIA Dental Clinic portal</p>

                <div class="next-appointment">
                    <div class="next-info">
                        <div class="label">Next Appointment</div>
                        <div class="title">@nextAppointment.Title</div>
                        <div class="meta">@nextAppointment.Date.ToString("dd/MM/yyyy") at @nextAppointment.Date.ToString("hh:mm tt")</div>
                    </div>
                    <div class="next-actions">
                        <button class="btn-outline" @onclick="NavigateToAppointments">📅 Book Appointment</button>
                        <button class="btn-outline ghost" @onclick="CallClinic">📞 Call Clinic</button>
                    </div>
                </div>
            </div>
            <div class="hero-deco">
                <svg width="80" height="80" viewBox="002424" fill="rgba(255,255,255,0.2)">
                    <path d="M1221.35l-1.45-1.32C5.415.36212.2828.525.424.4237.53c1.7403.41.814.52.09C13.093.8114.76316.5319.583225.42228.5c03.78-3.46.86-8.5511.54L1221.35z" />
                </svg>
            </div>
        </section>

        <!-- Stats Row -->
        <section class="stats-row">
            <div class="stat-card">
                <div class="icon blue">
                    <svg width="24" height="24" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Next Visit</div>
                    <div class="stat-value">@nextVisitDays days</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon success">
                    <svg width="24" height="24" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">@completedCount</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon warning">
                    <svg width="24" height="24" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                        <line x1="1" y1="10" x2="23" y2="10"></line>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Outstanding</div>
                    <div class="stat-value">₱@outstanding.ToString("N0")</div>
                </div>
            </div>
            <div class="stat-card">
                <div class="icon purple">
                    <svg width="24" height="24" viewBox="002424" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                        <polyline points="17 6 23 6 23 12"></polyline>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Total Spent</div>
                    <div class="stat-value">₱@totalSpent.ToString("N0")</div>
                </div>
            </div>
        </section>

        <!-- Panels -->
        <section class="panels">
            <div class="panel appointments">
                <div class="panel-header">
                    <h3>📅 Upcoming Appointments</h3>
                    <a class="view-all" href="#">View All</a>
                </div>
                <div class="panel-body">
                    @foreach (var a in upcoming)
                    {
                        <div class="appt-item">
                            <div class="left">
                                <div class="avatar">
                                    <svg width="24" height="24" viewBox="002424" fill="none" stroke="#3b82f6" stroke-width="2">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                                    </svg>
                                </div>
                            </div>
                            <div class="center">
                                <div class="appt-title">@a.Title</div>
                                <div class="appt-meta">@a.Provider — @a.Date.ToString("dd/MM/yyyy") • @a.Date.ToString("hh:mm tt")</div>
                            </div>
                            <div class="right">
                                <span class="status @a.Status.ToString().ToLower()">@a.Status</span>
                            </div>
                        </div>
                    }
                </div>
            </div>

            <div class="panel treatments">
                <div class="panel-header">
                    <h3>📋 Recent Treatments</h3>
                    <a class="view-all" href="#">View All</a>
                </div>
                <div class="panel-body">
                    @foreach (var t in recentTreatments)
                    {
                        <div class="treat-item">
                            <div class="t-left">
                                <div class="t-icon">
                                    <svg width="24" height="24" viewBox="002424" fill="none" stroke="#10b981" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="t-center">
                                <div class="t-title">@t.Title</div>
                                <div class="t-meta">@t.Provider — @t.Date.ToString("dd/MM/yyyy")</div>
                            </div>
                            <div class="t-right">
                                <div class="amount">₱@t.Price.ToString("N0")</div>
                                <div class="stars">⭐⭐⭐⭐⭐</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>

    </div>
</div>

@code {
    private string patientName = "Patient";
    
    protected override async Task OnInitializedAsync()
    {
   try
        {
   var session = await SessionService.GetCurrentSessionAsync();
          if (session == null)
       {
    // No session, redirect to login
         Navigation.NavigateTo("/login", true);
     return;
      }
   
  // Set patient name from session
         patientName = session.UserName ?? "Patient";
    }
     catch (Exception ex)
       {
     Debug.WriteLine($"[Dashboard] Error loading session: {ex.Message}");
            patientName = "Patient";
    }
    }

    private Appointment nextAppointment = new Appointment
    {
        Title = "Teeth Cleaning with Dr. Maria Santos",
        Provider = "Dr. Maria Santos",
        Date = new DateTime(2025, 9, 20, 10, 0, 0),
        Status = ApptStatus.Confirmed
    };

    private int nextVisitDays = 5;
    private int completedCount = 3;
    private int outstanding = 2500;
    private int totalSpent = 15800;

    private List<Appointment> upcoming = new List<Appointment>
    {
        new Appointment { Title = "Teeth Cleaning", Provider = "Dr. Maria Santos", Date = new DateTime(2025,9,20,10,0,0), Status = ApptStatus.Confirmed },
        new Appointment { Title = "Root Canal Follow-up", Provider = "Dr. Juan Dela Cruz", Date = new DateTime(2025,9,25,14,30,0), Status = ApptStatus.Scheduled }
    };

    private List<Treatment> recentTreatments = new List<Treatment>
    {
        new Treatment { Title = "Initial Consultation", Provider = "Dr. Maria Santos", Date = new DateTime(2025,8,15), Price = 1500 },
        new Treatment { Title = "X-Ray", Provider = "Dr. Maria Santos", Date = new DateTime(2025,8,15), Price = 800 }
    };

    private enum ApptStatus { Confirmed, Scheduled, Pending }

    private class Appointment
    {
        public string Title { get; set; } = string.Empty;
        public string Provider { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public ApptStatus Status { get; set; }
    }

    private class Treatment
    {
        public string Title { get; set; } = string.Empty;
        public string Provider { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public int Price { get; set; }
    }

    private void NavigateToAppointments()
    {
        Navigation.NavigateTo("/appointments");
    }

    private void CallClinic()
    {
        // Logic to call the clinic, e.g., open dialer with clinic's phone number
    }
}