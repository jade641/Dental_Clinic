@page "/dashboard"
@using System.Diagnostics
@inject Dental_Clinic.Services.SessionService SessionService
@inject NavigationManager Navigation
@inject Dental_Clinic.Services.AppointmentService AppointmentService
@inject Dental_Clinic.Services.ChatService ChatService

<link href="css/patientdashboard.css" rel="stylesheet" />

<div class="dashboard-page">
    <PatientNavBar />

    <!-- Main Content -->
    <div class="dashboard-content">
        <!-- Hero Card with Gradient -->
        <section class="hero-card">
            <!-- Heart Icon Decoration -->
            <div class="hero-heart-icon">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="currentColor">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                </svg>
            </div>

            <div class="hero-content">
                <!-- Greeting -->
                <div class="hero-greeting">
                    <h1>Good morning, @patientName!</h1>
                    <p class="subtitle">Welcome to your Aurelia Dental Clinic portal</p>
                </div>

                <!-- Next Appointment Box -->
                <div class="next-appointment-box">
                    <div class="appt-box-content">
                        <div class="appt-calendar-icon">
                            <svg width="56" height="56" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="4" width="18" height="18" rx="2" stroke="white" stroke-width="2"/>
                                <path d="M16 2V6M8 2V6M3 10H21" stroke="white" stroke-width="2"/>
                            </svg>
                        </div>
                        <div class="appt-box-info">
                            <div class="appt-box-label">Next Appointment</div>
                            <div class="appt-box-title">@(nextAppointment?.ServiceName ?? "No upcoming appointments")</div>
                            <div class="appt-box-date">@(nextAppointment != null ? $"{nextAppointment.AppointmentDate:dd/MM/yyyy} at {FormatTime(nextAppointment.StartTime ?? new TimeSpan(0))}" : "")</div>
                        </div>
                    </div>

                    <!-- Action Buttons Inside Box -->
                    <div class="appt-box-actions">
                        <button class="btn-book" @onclick='() => Navigation.NavigateTo("/appointments")'>
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            Book Appointment
                        </button>
                        <button class="btn-call">
                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- Stats Row Below Hero -->
        <section class="stats-row">
            <div class="stat-card">
                <div class="stat-icon blue">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Next Visit</div>
                    <div class="stat-value">@((nextAppointment?.AppointmentDate - DateTime.Today)?.Days ?? 0) days</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon green">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">@completedCount</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon orange">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="1" y="4" width="22" height="16" rx="2" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Outstanding</div>
                    <div class="stat-value">₱@outstanding.ToString("N0")</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-icon purple">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" stroke="currentColor" stroke-width="2"/>
                    </svg>
                </div>
                <div class="stat-content">
                    <div class="stat-label">Total Spent</div>
                    <div class="stat-value">₱@totalSpent.ToString("N0")</div>
                </div>
            </div>
        </section>

        <!-- Content Sections -->
        <div class="content-grid">
            <!-- Upcoming Appointments -->
            <section class="content-section">
                <div class="section-header">
                    <div class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                            <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <h2>Upcoming Appointments</h2>
                    </div>
                    <a href="/appointments" class="view-all-link">View All</a>
                </div>
                <div class="appointments-list">
                    @if (upcoming.Any())
                    {
                        @foreach (var appt in upcoming)
                        {
                            <div class="appointment-item">
                                <div class="appt-icon-wrapper">
                                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" stroke="currentColor" stroke-width="2"/>
                                    </svg>
                                </div>
                                <div class="appt-info">
                                    <div class="appt-name">@appt.ServiceName</div>
                                    <div class="appt-meta">@appt.DentistName • @appt.AppointmentDate.ToString("dd/MM/yyyy") • @FormatTime(appt.StartTime ?? new TimeSpan(0))</div>
                                </div>
                                <span class="status-badge status-@appt.Status.ToLower()">@appt.Status</span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <p>No upcoming appointments</p>
                        </div>
                    }
                </div>
            </section>

            <!-- Recent Treatments -->
            <section class="content-section">
                <div class="section-header">
                    <div class="section-title">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2"/>
                        </svg>
                        <h2>Recent Treatments</h2>
                    </div>
                    <a href="/history" class="view-all-link">View All</a>
                </div>
                <div class="treatments-list">
                    @foreach (var treatment in recentTreatments)
                    {
                        <div class="treatment-item">
                            <div class="treatment-icon-wrapper">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2"/>
                                </svg>
                            </div>
                            <div class="treatment-info">
                                <div class="treatment-name">@treatment.Title</div>
                                <div class="treatment-meta">@treatment.Provider • @treatment.Date.ToString("dd/MM/yyyy")</div>
                            </div>
                            <div class="treatment-right">
                                <div class="treatment-price">₱@treatment.Price.ToString("N0")</div>
                                <div class="treatment-rating">⭐⭐⭐⭐⭐</div>
                            </div>
                        </div>
                    }
                </div>
            </section>
        </div>
    </div>

    <!-- Chatbot UI -->
    @if (isChatOpen)
    {
        <div class="chat-window">
            <div class="chat-header">
                <div class="chat-header-info">
                    @if (chatState == "LiveChat")
                    {
                        <button class="chat-back-btn" @onclick="GoBackToFAQ" style="background:none;border:none;color:white;cursor:pointer;margin-right:8px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M19 12H5M12 19l-7-7 7-7"/>
                            </svg>
                        </button>
                    }
                    <div class="chat-logo">
                        <img src="css/bootstrap/Dental_Logo.png" alt="Logo" />
                        <span class="online-indicator"></span>
                    </div>
                    <div class="chat-title-group">
                        <h3>Aurelia Dental Clinic</h3>
                        <span class="chat-status">● Online</span>
                    </div>
                </div>
                <button class="chat-close-btn" @onclick="ToggleChat">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="chat-body" id="chatBody">
                @if (chatState == "FAQ")
                {
                    <div class="chat-welcome">
                        <div class="welcome-icon">
                            <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="1.5">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                            </svg>
                        </div>
                        <h4>Welcome! 👋</h4>
                        <p>How can we help you today? Choose a topic below or chat with our support team.</p>
                    </div>

                    <div class="faq-list">
                        <div class="faq-label">FREQUENT QUESTIONS</div>
                        @foreach (var faq in faqs)
                        {
                            <button class="faq-btn" @onclick="() => SelectFAQ(faq.Key)">
                                @faq.Key
                            </button>
                        }
                    </div>

                    <button class="start-chat-btn" @onclick="StartLiveChat">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                        </svg>
                        Chat with Support
                    </button>
                }
                else
                {
                    <div class="messages-list">
                        @foreach (var msg in messages)
                        {
                            <div class="message-bubble @(msg.Sender == "Patient" || msg.Sender == patientName ? "sent" : "received")">
                                @if (msg.Sender != "Patient" && msg.Sender != patientName)
                                {
                                    <div class="msg-sender">@msg.Sender</div>
                                }
                                <div class="msg-text">@msg.MessageText</div>
                                <div class="msg-time">@msg.Timestamp?.ToString("h:mm tt")</div>
                            </div>
                        }
                    </div>
                }
            </div>

            @if (chatState == "LiveChat")
            {
                <div class="chat-footer">
                    <div class="chat-input-wrapper">
                        <input type="text" placeholder="Type a message..." @bind="newMessage" @bind:event="oninput" @onkeypress="HandleKeyPress" />
                        <button class="send-btn" @onclick="SendMessage" disabled="@string.IsNullOrWhiteSpace(newMessage)">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="22" y1="2" x2="11" y2="13"></line>
                                <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                            </svg>
                        </button>
                    </div>
                </div>
            }
        </div>
    }

    <!-- Floating Chatbot Button -->
    <button class="chatbot-button" type="button" aria-label="Open Chat" @onclick="ToggleChat">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
    </button>
</div>

@code {
    private string patientName = "Patient";
    private int currentPatientId = 0;
    private int completedCount = 3;
    private decimal outstanding = 2500;
    private decimal totalSpent = 15800;

    private Models.Appointment? nextAppointment;
    private List<Models.Appointment> upcoming = new();

    // Settings state
    private bool showSettings = false;
    private bool appointmentReminders = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var session = await SessionService.GetCurrentSessionAsync();
            if (session == null)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }

            patientName = session.UserName ?? "Patient";
            currentPatientId = session.RoleSpecificId ?? 0;
            if (currentPatientId == 0)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }

            upcoming = (await AppointmentService.GetPatientAppointmentsAsync(currentPatientId))
                .Where(a => a.AppointmentDate >= DateTime.Today)
                .OrderBy(a => a.AppointmentDate)
                .ThenBy(a => a.StartTime)
                .Take(10)
                .ToList();

            nextAppointment = upcoming.FirstOrDefault();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[Dashboard] Error loading: {ex.Message}");
            patientName = "Patient";
        }
    }

    private void ToggleSettings()
    {
        showSettings = !showSettings;
    }

    private void EditProfile()
    {
        Navigation.NavigateTo("/patient-profile");
        showSettings = false;
    }

    private void MedicalUploads()
    {
        Navigation.NavigateTo("/history");
        showSettings = false;
    }

    private void HelpSupport()
    {
        Navigation.NavigateTo("/help");
        showSettings = false;
    }

    private void Logout()
    {
        Navigation.NavigateTo("/login", true);
        showSettings = false;
    }

    private void ToggleReminders(ChangeEventArgs e)
    {
        appointmentReminders = e.Value is bool b ? b : appointmentReminders;
    }

    private string FormatTime(TimeSpan time)
    {
        var hours = time.Hours;
        var minutes = time.Minutes;
        var ampm = hours >= 12 ? "PM" : "AM";
        if (hours > 12) hours -= 12;
        if (hours == 0) hours = 12;
        return $"{hours}:{minutes:00} {ampm}";
    }

    private List<Treatment> recentTreatments = new List<Treatment>
    {
        new Treatment { Title = "Initial Consultation", Provider = "Dr. Maria Santos", Date = new DateTime(2025, 8, 15), Price = 1500 },
        new Treatment { Title = "X-Ray", Provider = "Dr. Maria Santos", Date = new DateTime(2025, 8, 15), Price = 800 }
    };

    private class Treatment 
    { 
        public string Title { get; set; } = string.Empty; 
        public string Provider { get; set; } = string.Empty; 
        public DateTime Date { get; set; } 
        public int Price { get; set; } 
    }

    // Chat Logic
    private bool isChatOpen = false;
    private string chatState = "FAQ"; // "FAQ" or "LiveChat"
    private Dictionary<string, string> faqs = new();
    private List<Dental_Clinic.Models.ChatMessage> messages = new();
    private string newMessage = string.Empty;
    private Dental_Clinic.Models.ChatBotConversation? activeConversation;
    private string selectedFAQTitle = string.Empty;
    private string selectedFAQAnswer = string.Empty;

    private async Task ToggleChat()
    {
        isChatOpen = !isChatOpen;
        if (isChatOpen)
        {
            faqs = ChatService.GetFAQs();
            // Check if there's an active conversation to resume
            activeConversation = await ChatService.GetActiveConversationAsync(currentPatientId);
            if (activeConversation != null)
            {
                // Check if there are any messages in this conversation
                var msgs = await ChatService.GetMessagesAsync(activeConversation.ConversationID);
                if (msgs.Any())
                {
                    chatState = "LiveChat";
                    messages = msgs;
                    StateHasChanged();
                }
            }
        }
    }

    private async Task SelectFAQ(string question)
    {
        if (faqs.TryGetValue(question, out var answer))
        {
            // Ensure chat is active, but don't send the generic greeting
            await StartLiveChat(sendGreeting: false);

            if (activeConversation != null)
            {
                // Send Question as Patient
                await ChatService.SendMessageAsync(activeConversation.ConversationID, currentPatientId, "Patient", question);
                
                // Send Answer as Bot
                await ChatService.SendMessageAsync(activeConversation.ConversationID, 0, "Aurelia Bot", answer);
                
                await LoadMessages();
            }
        }
    }

    private void ClearFAQSelection()
    {
        selectedFAQTitle = string.Empty;
        selectedFAQAnswer = string.Empty;
    }

    private void GoBackToFAQ()
    {
        chatState = "FAQ";
    }

    private async Task StartLiveChat()
    {
        await StartLiveChat(true);
    }

    private async Task StartLiveChat(bool sendGreeting)
    {
        chatState = "LiveChat";
        if (activeConversation == null)
        {
            int conversationId = await ChatService.CreateConversationAsync(currentPatientId);
            activeConversation = new Dental_Clinic.Models.ChatBotConversation 
            { 
                ConversationID = conversationId, 
                PatientID = currentPatientId,
                Status = "Open"
            };
            
            if (sendGreeting)
            {
                // Add initial bot greeting
                await ChatService.SendMessageAsync(conversationId, 0, "Aurelia Bot", "Hello! I've connected you to our support system. Please leave your message and a receptionist will reply shortly.");
            }
        }
        
        await LoadMessages();
    }

    private async Task LoadMessages()
    {
        if (activeConversation != null)
        {
            messages = await ChatService.GetMessagesAsync(activeConversation.ConversationID);
            StateHasChanged();
        }
    }

    private async Task SendMessage()
    {
        if (string.IsNullOrWhiteSpace(newMessage) || activeConversation == null) return;

        var text = newMessage;
        newMessage = string.Empty;

        // Optimistic update
        messages.Add(new Dental_Clinic.Models.ChatMessage 
        { 
            Sender = "Patient", 
            MessageText = text, 
            Timestamp = DateTime.Now 
        });

        await ChatService.SendMessageAsync(activeConversation.ConversationID, currentPatientId, patientName, text);
        
        // Automated Reply for non-FAQ messages
        await Task.Delay(500); // Small delay for natural feel
        await ChatService.SendMessageAsync(activeConversation.ConversationID, 0, "Aurelia Bot", "Thank you for your message! A member of our staff will respond shortly. In the meantime, feel free to explore our FAQ section for quick answers.");

        await LoadMessages(); // Refresh to get ID/Timestamp
    }

    private async Task HandleKeyPress(KeyboardEventArgs e)
    {
        if (e.Key == "Enter")
        {
            await SendMessage();
        }
    }
}
