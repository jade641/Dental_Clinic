@page "/dashboard"
@using System.Diagnostics
@inject Dental_Clinic.Services.SessionService SessionService
@inject NavigationManager Navigation
@inject Dental_Clinic.Services.AppointmentService AppointmentService

<link href="css/patientdashboard.css" rel="stylesheet" />

<div class="dashboard-page">
    <!-- Navigation Bar -->
    <nav class="navbar">
        <div class="navbar-container">
            <a href="/dashboard" class="navbar-brand">
                <div class="navbar-logo">
                    <img src="css/bootstrap/Dental_Logo.png" alt="Aurelia Dental Logo" />
                </div>
                <div class="navbar-brand-text">
                    <h1>AURELIA DENTAL CLINIC - DR. JADE</h1>
                    <p>YOUR SMILE. OUR MASTERPIECE</p>
                </div>
            </a>

            <div class="navbar-menu">
                <ul class="nav-links">
                    <li>
                        <a href="/dashboard" class="nav-link active">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                                <polyline points="9 22 9 12 15 12 15 22"></polyline>
                            </svg>
                            Overview
                        </a>
                    </li>
                    <li>
                        <a href="/appointments" class="nav-link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                <line x1="16" y1="2" x2="16" y2="6"></line>
                                <line x1="8" y1="2" x2="8" y2="6"></line>
                                <line x1="3" y1="10" x2="21" y2="10"></line>
                            </svg>
                            Appointments
                        </a>
                    </li>
                    <li>
                        <a href="/history" class="nav-link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                <polyline points="14 2 14 8 20 8"></polyline>
                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                <polyline points="10 9 9 9 8 9"></polyline>
                            </svg>
                            History
                        </a>
                    </li>
                    <li>
                        <a href="/billing" class="nav-link">
                            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                                <line x1="1" y1="10" x2="23" y2="10"></line>
                            </svg>
                            Billing
                        </a>
                    </li>
                </ul>

                <div class="navbar-actions">
                    <div class="search-box">
                        <svg class="search-icon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="11" cy="11" r="8"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                        </svg>
                        <input type="text" placeholder="Search services, appointments..." />
                    </div>

                    <button class="notification-btn">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                            <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                        </svg>
                        <span class="notification-badge">2</span>
                    </button>

                    <button class="settings-btn" title="Settings">
                        <span class="settings-icon">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M12 15a3 3 0 1 0 0-6 3 3 0 0 0 0 6z"></path>
                                <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                            </svg>
                        </span>
                    </button>

                    <div class="user-profile">
                        <div class="user-avatar">@patientName.Substring(0,1).ToUpper()</div>
                        <div class="user-info">
                            <div class="user-name">@patientName</div>
                            <div class="user-role">Patient Portal</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <div class="dashboard-inner">
        <!-- Hero Card -->
        <section class="hero-card">
            <div class="hero-content">
                <h1>Good morning, <span>@(string.IsNullOrWhiteSpace(patientName) ? "Patient" : patientName)</span>!</h1>
                <p class="muted">Welcome to your AURELIA Dental Clinic portal</p>

                <div class="next-appointment">
                    <div class="next-info">
                        <div class="label">Next Appointment</div>
                        <div class="title">@nextAppointment?.ServiceName</div>
                        <div class="meta">@nextAppointment?.AppointmentDate.ToString("dd/MM/yyyy") at @(nextAppointment?.StartTime.HasValue == true ? FormatTime(nextAppointment.StartTime.Value) : "")</div>
                    </div>
                    <div class="next-actions">
                        <button class="btn-outline" @onclick='() => Navigation.NavigateTo("/appointments")'>📅 Book Appointment</button>
                        <button class="btn-outline ghost">📞 Call Clinic</button>
                    </div>
                </div>
            </div>
            <div class="hero-deco">
                <svg width="80" height="80" viewBox="0 0 24 24" fill="rgba(255,255,255,0.2)">
                    <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z" />
                </svg>
            </div>
        </section>

        <!-- Stats Row -->
        <section class="stats-row">
            <div class="stat-card">
                <div class="icon blue">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Next Visit</div>
                    <div class="stat-value">@((nextAppointment?.AppointmentDate - DateTime.Today)?.Days ?? 0) days</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="icon success">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">@completedCount</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="icon warning">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="1" y="4" width="22" height="16" rx="2" ry="2"></rect>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Outstanding</div>
                    <div class="stat-value">₱@outstanding.ToString("N0")</div>
                </div>
            </div>

            <div class="stat-card">
                <div class="icon purple">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                    </svg>
                </div>
                <div class="stat-text">
                    <div class="stat-label">Total Spent</div>
                    <div class="stat-value">₱@totalSpent.ToString("N0")</div>
                </div>
            </div>
        </section>

        <!-- Panels -->
        <section class="panels">
            <div class="panel appointments">
                <div class="panel-header">
                    <h3>📅 Upcoming Appointments</h3>
                    <a class="view-all" href="/appointments">View All</a>
                </div>
                <div class="panel-body">
                    @if (upcoming.Any())
                    {
                        @foreach (var appt in upcoming)
                        {
                            <div class="appt-item">
                                <div class="left">
                                    <div class="avatar">
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                                            <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"></path>
                                        </svg>
                                    </div>
                                </div>
                                <div class="center">
                                    <div class="appt-title">@appt.ServiceName</div>
                                    <div class="appt-meta">@appt.DentistName — @appt.AppointmentDate.ToString("MMM dd, yyyy") • @FormatTime(appt.StartTime ?? new TimeSpan(0))</div>
                                </div>
                                <div class="right">
                                    <span class="status @appt.Status.ToLower()">@appt.Status</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <h4>No upcoming appointments</h4>
                            <p>Book an appointment to see it here</p>
                        </div>
                    }
                </div>
            </div>

            <div class="panel treatments">
                <div class="panel-header">
                    <h3>📋 Recent Treatments</h3>
                    <a class="view-all" href="/history">View All</a>
                </div>
                <div class="panel-body">
                    @foreach (var t in recentTreatments)
                    {
                        <div class="treat-item">
                            <div class="t-left">
                                <div class="t-icon">
                                    <svg width="24" height="24" viewBox="002424" fill="none" stroke="#10b981" stroke-width="2">
                                        <polyline points="206917412"></polyline>
                                    </svg>
                                </div>
                            </div>
                            <div class="t-center">
                                <div class="t-title">@t.Title</div>
                                <div class="t-meta">@t.Provider — @t.Date.ToString("dd/MM/yyyy")</div>
                            </div>
                            <div class="t-right">
                                <div class="amount">₱@t.Price.ToString("N0")</div>
                                <div class="stars">⭐⭐⭐⭐⭐</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </section>
    </div>
</div>

@code {
    private string patientName = "Patient";
    private int currentPatientId =0;
    private int completedCount = 12; // Example value
    private decimal outstanding = 2500; // Example value
    private decimal totalSpent = 15800; // Example value

    private Models.Appointment? nextAppointment;
    private List<Models.Appointment> upcoming = new();

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var session = await SessionService.GetCurrentSessionAsync();
            if (session == null)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }

            patientName = session.UserName ?? "Patient";
            currentPatientId = session.RoleSpecificId ??0;
            if (currentPatientId ==0)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }

            // Load upcoming appointments from service
            upcoming = (await AppointmentService.GetPatientAppointmentsAsync(currentPatientId))
                .Where(a => a.AppointmentDate >= DateTime.Today)
                .OrderBy(a => a.AppointmentDate)
                .ThenBy(a => a.StartTime)
                .Take(10)
                .ToList();

            nextAppointment = upcoming.FirstOrDefault();
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[Dashboard] Error loading: {ex.Message}");
            patientName = "Patient";
        }
    }

    private string FormatTime(TimeSpan time)
    {
        var hours = time.Hours;
        var minutes = time.Minutes;
        var ampm = hours >=12 ? "PM" : "AM";
        if (hours >12) hours -=12;
        if (hours ==0) hours =12;
        return $"{hours}:{minutes:00} {ampm}";
    }

    // Sample treatments remain
    private List<Treatment> recentTreatments = new List<Treatment>
    {
        new Treatment { Title = "Initial Consultation", Provider = "Dr. Maria Santos", Date = new DateTime(2025,8,15), Price =1500 },
        new Treatment { Title = "X-Ray", Provider = "Dr. Maria Santos", Date = new DateTime(2025,8,15), Price =800 }
    };

    private class Treatment { public string Title { get; set; } = string.Empty; public string Provider { get; set; } = string.Empty; public DateTime Date { get; set; } public int Price { get; set; } }
}