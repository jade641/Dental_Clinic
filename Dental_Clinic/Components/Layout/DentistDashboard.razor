@page "/dentist-dashboard"
@using Microsoft.AspNetCore.Components.Routing
@using Dental_Clinic.Services
@using Dental_Clinic.Models
@inject NavigationManager Navigation
@inject AppointmentService AppointmentService
@inject DatabaseService DatabaseService
@inject SessionService SessionService
@implements IDisposable

<link href="css/dentistdashboard.css" rel="stylesheet" />

<div class="dashboard-page">
<DentistNavBar />

<!-- Main Content -->
<div class="dashboard-content">
    <!-- Hero Card with Gradient -->
    <div class="hero-card">
        <div class="hero-content">
            <div class="hero-text">
                <h1>Good morning, Dr.!</h1>
                <p class="subtitle">Ready to make smiles brighter today?</p>
            </div>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Today's Appointments</div>
                    <div class="stat-value">@todayAppointmentsCount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Completed</div>
                    <div class="stat-value">@completedCount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Patients</div>
                    <div class="stat-value">@totalPatientsCount</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Pending Treatments</div>
                    <div class="stat-value">@pendingTreatmentsCount</div>
                </div>
            </div>
        </div>

        <div class="hero-icon">
            <svg width="120" height="120" viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M32 8C24.268 8 18 14.268 18 22c0 3.866 1.567 7.368 4.101 9.899L18 36v4h4v-4l-4.101-4.101C15.567 29.368 14 25.866 14 22c0-9.941 8.059-18 18-18s18 8.059 18 18c0 3.866-1.567 7.368-4.101 9.899L42 36v4h4v-4l-4.101-4.101C44.433 29.368 46 25.866 46 22c0-7.732-6.268-14-14-14z" fill="white" opacity="0.15"/>
                <circle cx="32" cy="22" r="4" fill="white" opacity="0.2"/>
                <path d="M26 40c-2.209 0-4 1.791-4 4v12h4V44h8v12h4V44c0-2.209-1.791-4-4-4h-8z" fill="white" opacity="0.15"/>
                <path d="M18 36c-1.105 0-2 .895-2 2s.895 2 2 2 2-.895 2-2-.895-2-2-2zm28 0c-1.105 0-2 .895-2 2s.895 2 2 2 2-.895 2-2-.895-2-2-2z" fill="white" opacity="0.2"/>
            </svg>
        </div>
    </div>

        <!-- Today's Schedule Section -->
        <div class="schedule-section">
            <div class="section-header">
                <div class="section-title">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                        <line x1="16" y1="2" x2="16" y2="6" />
                        <line x1="8" y1="2" x2="8" y2="6" />
                        <line x1="3" y1="10" x2="21" y2="10" />
                    </svg>
                    <h2>Today's Schedule</h2>
                </div>
                <div class="appointment-badge">@appointments.Count appointments</div>
            </div>

            <div class="schedule-list">
                @if (appointments.Count == 0)
                {
                    <div class="no-appointments">
                        <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
                            <line x1="16" y1="2" x2="16" y2="6" />
                            <line x1="8" y1="2" x2="8" y2="6" />
                            <line x1="3" y1="10" x2="21" y2="10" />
                        </svg>
                        <p>No appointments scheduled for today</p>
                    </div>
                }
                else
                {
                    @foreach (var appointment in appointments)
                    {
                        <div class="appointment-item">
                            <div class="appt-time">
                                <div class="time-icon-wrapper">
                                    <svg class="time-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="#3b82f6" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <polyline points="12 6 12 12 16 14" />
                                    </svg>
                                </div>
                                <div class="time-info">
                                    <div class="time">@(DateTime.Today.Add(appointment.StartTime ?? TimeSpan.Zero).ToString("h:mm tt"))</div>
                                </div>
                            </div>
                            <div class="appt-details">
                                <div class="patient-info-row">
                                    @if (!string.IsNullOrEmpty(appointment.PatientAvatar))
                                    {
                                        <img src="@appointment.PatientAvatar" alt="@appointment.PatientName" class="patient-avatar-small" />
                                    }
                                    else
                                    {
                                        <div class="patient-avatar-placeholder-small">
                                            @appointment.PatientName.Substring(0, 1).ToUpper()
                                        </div>
                                    }
                                    <div class="patient-name">@appointment.PatientName</div>
                                </div>
                                <div class="treatment-info">@appointment.ServiceName â€¢ @((appointment.EndTime - appointment.StartTime)?.TotalMinutes ?? 0) min</div>
                            </div>
                            <div class="appt-actions">
                                <span class="status-badge status-@appointment.Status.ToLower()">@appointment.Status</span>
                                <button class="menu-btn" @onclick="() => ShowAppointmentMenu(appointment.AppointmentID)" title="More options">
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <circle cx="12" cy="5" r="2" />
                                        <circle cx="12" cy="12" r="2" />
                                        <circle cx="12" cy="19" r="2" />
                                    </svg>
                                </button>
                            </div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>
</div>

@code {
    private string searchQuery = string.Empty;
    private string currentUrl = string.Empty;
    private int todayAppointmentsCount = 0;
    private int completedCount = 0;
    private int totalPatientsCount = 0;
    private int pendingTreatmentsCount = 0;
    private List<Appointment> appointments = new List<Appointment>();

    protected override async Task OnInitializedAsync()
    {
        currentUrl = Navigation.Uri;
        Navigation.LocationChanged += OnLocationChanged;
        await LoadDashboardData();
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = e.Location;
        StateHasChanged();
    }

    private async Task LoadDashboardData()
    {
        // Get current session to filter by dentist
        var session = await SessionService.GetCurrentSessionAsync();
        int? dentistId = null;
        
        if (session != null && session.Role == "Dentist")
        {
            dentistId = session.RoleSpecificId;
        }

        // Load Today's Appointments
        appointments = await AppointmentService.GetAppointmentsInRangeAsync(DateTime.Today, DateTime.Today, dentistId);
        todayAppointmentsCount = appointments.Count;
        
        // Calculate stats from loaded appointments
        // completedCount = appointments.Count(a => a.Status == "Completed"); // Only counts today's completed
        if (dentistId.HasValue)
        {
            completedCount = await DatabaseService.GetTotalCompletedAppointmentsForDentistAsync(dentistId.Value);
        }
        else
        {
            completedCount = appointments.Count(a => a.Status == "Completed");
        }
        
        pendingTreatmentsCount = appointments.Count(a => a.Status == "Scheduled" || a.Status == "Confirmed");

        // Load Total Patients Count
        // Note: Currently fetching all patients. Ideally should filter by dentist's patients if that relationship exists.
        var patients = await DatabaseService.GetAllPatientsDetailedAsync();
        totalPatientsCount = patients.Count;
    }

    private void ShowAppointmentMenu(int appointmentId)
    {
        Console.WriteLine($"Show menu for appointment {appointmentId}");
    }

    public void Dispose()
    {
        Navigation.LocationChanged -= OnLocationChanged;
    }
}