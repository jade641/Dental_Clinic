@page "/schedule"
@using Microsoft.AspNetCore.Components.Routing
@using Dental_Clinic.Models
@using Dental_Clinic.Services
@inject NavigationManager Navigation
@inject AppointmentService AppointmentService
@inject DatabaseService DatabaseService
@inject SessionService SessionService
@implements IDisposable

<link href="css/dentistschedule.css" rel="stylesheet" />

<div class="page-wrapper">
    <DentistNavBar />

    <!-- Main Content -->
    <main class="main-content">
        <div class="schedule-header">
            <h2>My Schedule</h2>
            <div class="schedule-controls">
                <div class="view-tabs">
                    <button class="tab-btn @(currentView == "Day" ? "active" : "")"
                        @onclick='() => ChangeView("Day")'>Day</button>
                    <button class="tab-btn @(currentView == "Week" ? "active" : "")"
                        @onclick='() => ChangeView("Week")'>Week</button>
                    <button class="tab-btn @(currentView == "Month" ? "active" : "")"
                        @onclick='() => ChangeView("Month")'>Month</button>
                </div>
                <button class="new-appointment-btn" @onclick="OpenNewAppointmentModal">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Filter
                </button>
                <button class="new-appointment-btn" @onclick="OpenNewAppointmentModal">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Appointment
                </button>
            </div>
        </div>

        <div class="calendar-controls">
            <button class="nav-arrow" @onclick="NavigatePrevious">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="15 18 9 12 15 6"></polyline>
                </svg>
            </button>
            <h3 class="current-month">@currentMonthYear</h3>
            <button class="nav-arrow" @onclick="NavigateNext">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <polyline points="9 18 15 12 9 6"></polyline>
                </svg>
            </button>
            <button class="today-btn" @onclick="GoToToday">Today</button>
        </div>

        <div class="calendar-container">
            <div class="calendar-grid">
                <div class="time-column">
                    <div class="time-header"></div>
                    @foreach (var time in timeSlots)
                    {
                        <div class="time-slot">@time</div>
                    }
                </div>

                @for (int i = 0; i < 7; i++)
                {
                    var dayIndex = i;
                    var currentDayDate = weekStart.AddDays(i);
                    var isToday = currentDayDate.Date == DateTime.Today;

                    <div class="day-column @(isToday ? "today" : "")">
                        <div class="day-header">
                            <div class="day-name">@currentDayDate.ToString("ddd")</div>
                            <div class="day-number @(isToday ? "current" : "")">@currentDayDate.Day</div>
                        </div>
                        @foreach (var time in timeSlots)
                        {
                            var timeSpan = ParseTimeSlot(time);
                            <div class="calendar-cell" @onclick="() => HandleCellClick(currentDayDate, time)">
                                @foreach (var appt in GetAppointmentsForSlot(currentDayDate, timeSpan))
                                {
                                    <div class="appointment-block @(appt.Status == "Completed" ? "completed-appt" : "")" 
                                         title="@appt.PatientName - @appt.ServiceName">
                                        <div class="appointment-patient">@appt.PatientName</div>
                                        <div class="appointment-treatment">
                                            @appt.ServiceName
                                            @if(appt.Status == "Completed") { <span class="completed-badge">(Done)</span> }
                                        </div>
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        </div>
    </main>

    @if (showTreatmentModal && selectedAppointment != null)
    {
        <div class="modal-backdrop" @onclick="CloseTreatmentModal">
            <div class="modal-content" @onclick:stopPropagation>
                <div class="modal-header">
                    <h3>Complete Appointment</h3>
                    <button class="icon-button" @onclick="CloseTreatmentModal">×</button>
                </div>
                <div class="modal-body">
                    @if (hasPastDue)
                    {
                        <div class="alert alert-warning">
                            <strong>Warning:</strong> This patient has a past due balance of
                            ₱@patientCurrentBalance.ToString("N2").
                            Please remind them to settle their account.
                        </div>
                    }

                    <div class="form-group">
                        <label>Patient</label>
                        <input type="text" class="form-control" value="@selectedAppointment.PatientName" readonly />
                    </div>
                    <div class="form-group">
                        <label>Service Performed</label>
                        <input type="text" class="form-control" value="@selectedAppointment.ServiceName" readonly />
                    </div>

                    <div class="form-row">
                        <div class="form-group" style="flex: 1;">
                            <label>Base Service Fee</label>
                            <input type="text" class="form-control readonly" value="₱@baseServiceCost.ToString("N2")" readonly />
                        </div>
                        <div class="form-group" style="flex: 1;">
                            <label>Current Balance</label>
                            <input type="text" class="form-control readonly" value="₱@patientCurrentBalance.ToString("N2")" readonly />
                        </div>
                    </div>

                    <div class="form-group">
                        <label>Diagnosis</label>
                        <textarea class="form-control" @bind="diagnosis" rows="2"
                            placeholder="Enter diagnosis..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Treatment Notes (Procedures done)</label>
                        <textarea class="form-control" @bind="treatmentNotes" rows="2"
                            placeholder="e.g., 2 surfaces on Tooth 14..."></textarea>
                    </div>
                    <div class="form-group">
                        <label>Final Cost (PHP)</label>
                        <input type="number" class="form-control" @bind="finalCost" step="0.01" />
                        <small class="text-muted">Adjust this if the procedure was more complex than expected. This amount
                            will be added to the patient's balance.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button class="btn-cancel" @onclick="CloseTreatmentModal" disabled="@isProcessing">Cancel</button>
                    <button class="btn-save" @onclick="SaveTreatmentRecord" disabled="@isProcessing">
                        @if (isProcessing)
                        {
                            <span>Processing...</span>
                        }
                        else
                        {
                            <span>Complete & Update Balance</span>
                        }
                    </button>
                </div>
            </div>
        </div>
    }

    @if (showSuccessModal)
    {
        <div class="modal-backdrop success-modal-backdrop" @onclick="CloseSuccessModal">
            <div class="modal-content success-modal-content" @onclick:stopPropagation>
                <div class="success-icon">
                    <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                </div>
                <h3 class="success-title">Transaction Successful!</h3>
                <p class="success-message">The appointment has been completed and the patient's balance has been updated.</p>
                <button class="btn-save btn-full-width" @onclick="CloseSuccessModal">OK</button>
            </div>
        </div>
    }
</div>

@code {
    private DateTime currentDate = DateTime.Now;
    private DateTime weekStart;
    private string[] timeSlots = new[] { "8 AM", "9 AM", "10 AM", "11 AM", "12 PM", "1 PM", "2 PM", "3 PM", "4 PM", "5 PM" };
    private string currentView = "Week";
    private string currentMonthYear = string.Empty;
    private string searchQuery = string.Empty;
    private List<Appointment> appointments = new();
    private User? currentUser;

    // Modal State
    private bool showTreatmentModal = false;
    private Appointment? selectedAppointment;
    private string diagnosis = string.Empty;
    private string treatmentNotes = string.Empty;
    private decimal finalCost = 0;
    private decimal baseServiceCost = 0;
    private decimal patientCurrentBalance = 0;
    private bool hasPastDue = false;
    private bool isProcessing = false; // Prevent double clicks

    // Success Modal State
    private bool showSuccessModal = false;

    protected override async Task OnInitializedAsync()
    {
        var session = await SessionService.GetCurrentSessionAsync();
        if (session == null)
        {
            Navigation.NavigateTo("/");
            return;
        }

        InitializeCalendar();
        await LoadAppointmentsAsync();
    }

    private void InitializeCalendar()
    {
        currentMonthYear = currentDate.ToString("MMMM yyyy");

        // Calculate start of the week (Monday)
        int diff = (7 + (currentDate.DayOfWeek - DayOfWeek.Monday)) % 7;
        weekStart = currentDate.AddDays(-1 * diff).Date;
    }

    private async Task LoadAppointmentsAsync()
    {
        // Load appointments for the current week
        var startDate = weekStart;
        var endDate = weekStart.AddDays(7);

        var session = await SessionService.GetCurrentSessionAsync();
        int? dentistId = session?.RoleSpecificId;

        var allAppointments = await AppointmentService.GetAppointmentsInRangeAsync(startDate, endDate, dentistId);
        
        // Filter: Only show Confirmed or Completed appointments. Hide Pending/Cancelled.
        appointments = allAppointments
            .Where(a => a.Status == "Confirmed" || a.Status == "Completed")
            .ToList();
            
        StateHasChanged();
    }

    private void ChangeView(string view)
    {
        currentView = view;
        // Logic to change view mode would go here
        // For now we stick to Week view as per the CSS grid layout
        StateHasChanged();
    }

    private async Task NavigatePrevious()
    {
        currentDate = currentDate.AddDays(-7);
        InitializeCalendar();
        await LoadAppointmentsAsync();
    }

    private async Task NavigateNext()
    {
        currentDate = currentDate.AddDays(7);
        InitializeCalendar();
        await LoadAppointmentsAsync();
    }

    private async Task GoToToday()
    {
        currentDate = DateTime.Now;
        InitializeCalendar();
        await LoadAppointmentsAsync();
    }

    private async Task HandleCellClick(DateTime date, string timeSlot)
    {
        // Find appointment in this slot
        var timeSpan = ParseTimeSlot(timeSlot);
        var appt = GetAppointmentsForSlot(date, timeSpan).FirstOrDefault();

        if (appt != null)
        {
            // Prevent opening modal if already completed
            if (appt.Status == "Completed")
            {
                // Optional: Show a "View Only" modal or just do nothing
                return;
            }
            await OpenTreatmentModal(appt);
        }
    }
    private async Task OpenTreatmentModal(Appointment appt)
    {
        selectedAppointment = appt;
        diagnosis = "";
        treatmentNotes = "";

        // Fetch Base Cost
        if (appt.ServiceID.HasValue)
        {
            baseServiceCost = await DatabaseService.GetServiceBaseCostAsync(appt.ServiceID.Value);
        }
        else
        {
            baseServiceCost = 0;
        }
        finalCost = baseServiceCost; // Default to base cost

        // Fetch Patient Balance Info
        patientCurrentBalance = await DatabaseService.GetPatientBalanceAsync(appt.PatientID);
        hasPastDue = await DatabaseService.HasPastDueBalanceAsync(appt.PatientID);

        showTreatmentModal = true;
    }
    private void CloseTreatmentModal()
    {
        showTreatmentModal = false;
        selectedAppointment = null;
    }

    private async Task SaveTreatmentRecord()
    {
        if (selectedAppointment == null || isProcessing) return;

        isProcessing = true; // Disable button
        StateHasChanged();

        bool success = await DatabaseService.UpdateAppointmentCostAndTreatmentAsync(
        selectedAppointment.AppointmentID,
        selectedAppointment.PatientID,
        finalCost,
        treatmentNotes,
        diagnosis
        );

        if (success)
        {
            await LoadAppointmentsAsync(); // Refresh schedule
            CloseTreatmentModal();
            showSuccessModal = true; // Show success message
        }
        
        isProcessing = false; // Re-enable (though modal is closed)
        StateHasChanged();
    }

    private void CloseSuccessModal()
    {
        showSuccessModal = false;
    }

    private void OpenNewAppointmentModal()
    {
        Console.WriteLine("Opening new appointment modal");
    }

    private TimeSpan ParseTimeSlot(string timeSlot)
    {
        // Convert "8 AM" to TimeSpan
        var dt = DateTime.ParseExact(timeSlot, "h tt", System.Globalization.CultureInfo.InvariantCulture);
        return dt.TimeOfDay;
    }

    private IEnumerable<Appointment> GetAppointmentsForSlot(DateTime date, TimeSpan time)
    {
        return appointments.Where(a =>
        a.AppointmentDate.Date == date.Date &&
        a.StartTime.HasValue &&
        a.StartTime.Value.Hours == time.Hours);
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}