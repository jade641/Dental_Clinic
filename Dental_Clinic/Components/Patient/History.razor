@page "/history"
@inject NavigationManager Navigation

<link href="css/patientdashboard.css" rel="stylesheet" />

<header class="top-navbar">
    <div class="navbar-left">
        <div class="clinic-brand">
            <div class="clinic-logo">
                <img src="css/bootstrap/Dental_Logo.png" alt="Aurelia Dental Logo" />
            </div>
            <div class="clinic-info">
                <h1 class="clinic-name">AURELIA DENTAL CLINIC - DR. JADE</h1>
                <p class="clinic-tagline">YOUR SMILE, OUR MASTERPIECE</p>
            </div>
        </div>
        <nav class="nav-tabs">
            <NavLink href="/dashboard" class="nav-tab" Match="NavLinkMatch.All">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M3 9L12 2L21 9V20C21 20.5304 20.7893 21.0391 20.4142 21.4142C20.0391 21.7893 19.5304 22 19 22H5C4.46957 22 3.96086 21.7893 3.58579 21.4142C3.21071 21.0391 3 20.5304 3 20V9Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Overview
            </NavLink>
            <NavLink href="/appointments" class="nav-tab">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                Appointments
            </NavLink>
            <NavLink href="/history" class="nav-tab">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
                History
            </NavLink>
        </nav>
    </div>
    <div class="navbar-right">
        <div class="search-bar">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="11" cy="11" r="8" stroke="currentColor" stroke-width="2" />
                <path d="M21 21L16.65 16.65" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            <input type="text" placeholder="Search services, appointments..." />
        </div>
        <button class="icon-button" type="button">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M18 8C18 6.4087 17.3679 4.88258 16.2426 3.75736C15.1174 2.63214 13.5913 2 12 2C10.4087 2 8.88258 2.63214 7.75736 3.75736C6.63214 4.88258 6 6.4087 6 8C6 15 3 17 3 17H21C21 17 18 15 18 8Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
            </svg>
            <span class="notification-badge">2</span>
        </button>
        <div class="user-profile">
            <div class="user-avatar">P</div>
            <div class="user-details">
                <span class="user-name">Patient</span>
                <span class="user-role">Patient Portal</span>
            </div>
        </div>
    </div>
</header>

<div class="dashboard-page">
    <div class="dashboard-inner">
        <!-- Page Header -->
        <div class="page-header-section">
            <div class="page-header-content">
                <h1 class="page-title">Treatment History</h1>
                <p class="page-subtitle">View your complete treatment records and medical history</p>
            </div>
            <div class="page-header-actions">
                <button class="btn-filter" @onclick="ToggleFilter">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Filter
                </button>
                <button class="btn-export" @onclick="ExportHistory">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <!-- Filter Panel -->
        @if (showFilter)
        {
            <div class="filter-panel">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Status</label>
                        <select @bind="filterStatus" class="filter-select">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Doctor</label>
                        <select @bind="filterDoctor" class="filter-select">
                            <option value="">All Doctors</option>
                            <option value="Maria Santos">Dr. Maria Santos</option>
                            <option value="Juan Dela Cruz">Dr. Juan Dela Cruz</option>
                            <option value="Sarah Johnson">Dr. Sarah Johnson</option>
                        </select>
                    </div>
                    <div class="filter-group date-range">
                        <label>Date Range</label>
                        <div class="date-inputs">
                            <input type="date" @bind="filterDateFrom" class="filter-input" />
                            <span class="date-separator">to</span>
                            <input type="date" @bind="filterDateTo" class="filter-input" />
                        </div>
                    </div>
                    <button class="btn-clear-filter" @onclick="ClearFilters">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        Clear
                    </button>
                </div>
            </div>
        }

        <!-- Treatment History List -->
        <section class="history-section">
            @if (GetFilteredTreatments().Any())
            {
                <div class="history-list">
                    @foreach (var treatment in GetFilteredTreatments())
                    {
                        <div class="treatment-card" @onclick="() => ViewTreatmentDetails(treatment.Id)">
                            <div class="treatment-status-indicator @treatment.Status.ToLower()">
                                @if (treatment.Status == "completed")
                                {
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polyline points="20 6 9 17 4 12"></polyline>
                                    </svg>
                                }
                                else if (treatment.Status == "pending")
                                {
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <polyline points="12 6 12 12 16 14"></polyline>
                                    </svg>
                                }
                                else
                                {
                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10"></circle>
                                        <line x1="15" y1="9" x2="9" y2="15"></line>
                                        <line x1="9" y1="9" x2="15" y2="15"></line>
                                    </svg>
                                }
                            </div>

                            <div class="treatment-content">
                                <div class="treatment-header">
                                    <div class="treatment-main-info">
                                        <h3 class="treatment-name">@treatment.Name</h3>
                                        <span class="treatment-status-badge @treatment.Status.ToLower()">
                                            @treatment.Status
                                        </span>
                                    </div>
                                    <div class="treatment-price">₱@treatment.Price.ToString("N0")</div>
                                </div>

                                <div class="treatment-meta">
                                    <div class="meta-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                        Dr. @treatment.DoctorName
                                    </div>
                                    <div class="meta-item">
                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                        </svg>
                                        @treatment.Date.ToString("MMM dd, yyyy")
                                    </div>
                                </div>

                                @if (!string.IsNullOrEmpty(treatment.Notes))
                                {
                                    <p class="treatment-notes">@treatment.Notes</p>
                                }

                                @if (treatment.Rating > 0)
                                {
                                    <div class="treatment-rating">
                                        @for (int i = 1; i <= 5; i++)
                                        {
                                            <span class="star @(i <= treatment.Rating ? "filled" : "")">★</span>
                                        }
                                    </div>
                                }
                            </div>

                            <div class="treatment-arrow">
                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <polyline points="9 18 15 12 9 6"></polyline>
                                </svg>
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <div class="empty-state">
                    <svg width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                        <polyline points="14 2 14 8 20 8"></polyline>
                        <line x1="16" y1="13" x2="8" y2="13"></line>
                        <line x1="16" y1="17" x2="8" y2="17"></line>
                        <polyline points="10 9 9 9 8 9"></polyline>
                    </svg>
                    <h4>No treatment records found</h4>
                    <p>Your treatment history will appear here</p>
                </div>
            }
        </section>
    </div>
</div>

@if (showDetailsModal && selectedTreatment != null)
{
    <div class="modal-overlay" @onclick="CloseDetailsModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Treatment Details</h2>
                <button class="btn-close" @onclick="CloseDetailsModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="detail-group">
                    <label>Treatment</label>
                    <p>@selectedTreatment.Name</p>
                </div>

                <div class="detail-group">
                    <label>Doctor</label>
                    <p>Dr. @selectedTreatment.DoctorName</p>
                </div>

                <div class="detail-group">
                    <label>Date</label>
                    <p>@selectedTreatment.Date.ToString("MMMM dd, yyyy")</p>
                </div>

                <div class="detail-group">
                    <label>Status</label>
                    <span class="treatment-status-badge @selectedTreatment.Status.ToLower()">
                        @selectedTreatment.Status
                    </span>
                </div>

                <div class="detail-group">
                    <label>Price</label>
                    <p class="detail-price">₱@selectedTreatment.Price.ToString("N0")</p>
                </div>

                @if (selectedTreatment.Rating > 0)
                {
                    <div class="detail-group">
                        <label>Rating</label>
                        <div class="treatment-rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <span class="star @(i <= selectedTreatment.Rating ? "filled" : "")">★</span>
                            }
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(selectedTreatment.Notes))
                {
                    <div class="detail-group">
                        <label>Notes</label>
                        <p>@selectedTreatment.Notes</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(selectedTreatment.Prescription))
                {
                    <div class="detail-group">
                        <label>Prescription</label>
                        <p>@selectedTreatment.Prescription</p>
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseDetailsModal">Close</button>
                <button class="btn-primary" @onclick="DownloadReceipt">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Download Receipt
                </button>
            </div>
        </div>
    </div>
}

@code {
    private List<TreatmentRecord> treatments = new();
    private bool showFilter = false;
    private string filterStatus = "";
    private string filterDoctor = "";
    private DateTime? filterDateFrom = null;
    private DateTime? filterDateTo = null;

    private bool showDetailsModal = false;
    private TreatmentRecord? selectedTreatment = null;

    protected override void OnInitialized()
    {
        // Sample treatment history data
        treatments = new List<TreatmentRecord>
        {
            new TreatmentRecord
            {
                Id = 1,
                Name = "Initial Consultation",
                DoctorName = "Maria Santos",
                Date = new DateTime(2025, 8, 15),
                Price = 1500,
                Status = "completed",
                Rating = 5,
                Notes = "Comprehensive dental examination completed. Patient shows good oral hygiene.",
                Prescription = "No prescription needed at this time."
            },
            new TreatmentRecord
            {
                Id = 2,
                Name = "X-Ray",
                DoctorName = "Maria Santos",
                Date = new DateTime(2025, 8, 15),
                Price = 800,
                Status = "completed",
                Rating = 5,
                Notes = "Full mouth X-ray taken for comprehensive assessment."
            },
            new TreatmentRecord
            {
                Id = 3,
                Name = "Cavity Filling",
                DoctorName = "Juan Dela Cruz",
                Date = new DateTime(2025, 8, 22),
                Price = 3500,
                Status = "completed",
                Rating = 4,
                Notes = "Composite filling on tooth #14. Patient tolerated procedure well.",
                Prescription = "Take Ibuprofen 400mg as needed for pain. Avoid hard foods for 24 hours."
            },
            new TreatmentRecord
            {
                Id = 4,
                Name = "Teeth Cleaning",
                DoctorName = "Sarah Johnson",
                Date = new DateTime(2025, 9, 10),
                Price = 2500,
                Status = "completed",
                Rating = 5,
                Notes = "Deep cleaning completed. Minimal tartar buildup noted."
            },
            new TreatmentRecord
            {
                Id = 5,
                Name = "Root Canal Treatment",
                DoctorName = "Maria Santos",
                Date = new DateTime(2025, 12, 5),
                Price = 15000,
                Status = "pending",
                Rating = 0,
                Notes = "Scheduled for next month. Pre-treatment consultation completed."
            }
        };
    }

    private List<TreatmentRecord> GetFilteredTreatments()
    {
        var filtered = treatments.AsEnumerable();

        // Status filter
        if (!string.IsNullOrEmpty(filterStatus))
        {
            filtered = filtered.Where(t => t.Status.Equals(filterStatus, StringComparison.OrdinalIgnoreCase));
        }

        // Doctor filter
        if (!string.IsNullOrEmpty(filterDoctor))
        {
            filtered = filtered.Where(t => t.DoctorName.Equals(filterDoctor, StringComparison.OrdinalIgnoreCase));
        }

        // Date range filter
        if (filterDateFrom.HasValue)
        {
            filtered = filtered.Where(t => t.Date >= filterDateFrom.Value);
        }

        if (filterDateTo.HasValue)
        {
            filtered = filtered.Where(t => t.Date <= filterDateTo.Value);
        }

        return filtered.OrderByDescending(t => t.Date).ToList();
    }

    private void ToggleFilter()
    {
        showFilter = !showFilter;
    }

    private void ClearFilters()
    {
        filterStatus = "";
        filterDoctor = "";
        filterDateFrom = null;
        filterDateTo = null;
    }

    private void ExportHistory()
    {
        // Implement export functionality (CSV, PDF, etc.)
        Console.WriteLine("Exporting treatment history...");
    }

    private void ViewTreatmentDetails(int treatmentId)
    {
        selectedTreatment = treatments.FirstOrDefault(t => t.Id == treatmentId);
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedTreatment = null;
    }

    private void DownloadReceipt()
    {
        // Implement receipt download functionality
        Console.WriteLine($"Downloading receipt for treatment {selectedTreatment?.Id}...");
    }

    // Model
    public class TreatmentRecord
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string DoctorName { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public decimal Price { get; set; }
        public string Status { get; set; } = string.Empty;
        public int Rating { get; set; }
        public string Notes { get; set; } = string.Empty;
        public string Prescription { get; set; } = string.Empty;
    }
}}