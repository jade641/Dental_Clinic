@page "/history"
@inject NavigationManager Navigation
@inject Dental_Clinic.Services.SessionService SessionService

<link href="css/patientdashboard.css" rel="stylesheet" />
<link href="css/PatientHistory.css" rel="stylesheet" />

<div class="dashboard-page">
    <PatientNavBar />

    <div class="dashboard-content">
        <div class="schedule-header">
            <h2 class="schedule-title">Treatment History</h2>
            <div class="schedule-actions">
                <button class="filter-btn" @onclick="ToggleFilter">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                    </svg>
                    Filter
                </button>
                <button class="export-btn" @onclick="ExportHistory">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                        <polyline points="7 10 12 15 17 10"></polyline>
                        <line x1="12" y1="15" x2="12" y2="3"></line>
                    </svg>
                    Export
                </button>
            </div>
        </div>

        @if (showFilter)
        {
            <div class="filter-panel">
                <div class="filter-row">
                    <div class="filter-group">
                        <label>Status</label>
                        <select @bind="filterStatus" class="filter-select">
                            <option value="">All Status</option>
                            <option value="completed">Completed</option>
                            <option value="pending">Pending</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>Doctor</label>
                        <select @bind="filterDoctor" class="filter-select">
                            <option value="">All Doctors</option>
                            <option value="Maria Santos">Dr. Maria Santos</option>
                            <option value="Juan Dela Cruz">Dr. Juan Dela Cruz</option>
                            <option value="Sarah Johnson">Dr. Sarah Johnson</option>
                        </select>
                    </div>
                    <div class="filter-group date-range">
                        <label>Date Range</label>
                        <div class="date-inputs">
                            <input type="date" @bind="filterDateFrom" class="filter-input" />
                            <span class="date-separator">to</span>
                            <input type="date" @bind="filterDateTo" class="filter-input" />
                        </div>
                    </div>
                    <button class="btn-clear-filter" @onclick="ClearFilters">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <line x1="18" y1="6" x2="6" y2="18"></line>
                            <line x1="6" y1="6" x2="18" y2="18"></line>
                        </svg>
                        Clear
                    </button>
                </div>
            </div>
        }

        <div class="schedule-grid">
            <div class="schedule-section">
                <div class="appointments-list">
                    @if (GetFilteredTreatments().Any())
                    {
                        @foreach (var treatment in GetFilteredTreatments())
                        {
                            <div class="appointment-card" @onclick="() => ViewTreatmentDetails(treatment.Id)">
                                <div class="appointment-icon @GetIconColorClass(treatment.Status)">
                                    @if (treatment.Status == "completed")
                                    {
                                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    }
                                    else if (treatment.Status == "pending")
                                    {
                                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <circle cx="12" cy="12" r="10"></circle>
                                            <polyline points="12 6 12 12 16 14"></polyline>
                                        </svg>
                                    }
                                    else
                                    {
                                        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    }
                                </div>
                                <div class="appointment-content">
                                    <h4 class="patient-name">@treatment.Name</h4>
                                    <p class="appointment-service">Performed by Dr. @treatment.DoctorName</p>
                                    <div class="appointment-details">
                                        <span class="detail-item">
                                            @treatment.Date.ToString("dd/MM/yyyy")
                                        </span>
                                    </div>
                                    @if (treatment.Rating > 0)
                                    {
                                        <div class="treatment-rating">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                <span class="star @(i <= treatment.Rating ? "filled" : "")">★</span>
                                            }
                                        </div>
                                    }
                                </div>
                                <div class="appointment-actions">
                                    <span class="detail-item price-tag">₱@treatment.Price.ToString("N0")</span>
                                    <span class="status-badge @GetStatusClass(treatment.Status)">@treatment.Status</span>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <svg width="48" height="48" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" xmlns="http://www.w3.org/2000/svg">
                                <path d="M13 2H6C5.46957 2 4.96086 2.21071 4.58579 2.58579C4.21071 2.96086 4 3.46957 4 4V20C4 20.5304 4.21071 21.0391 4.58579 21.4142C4.96086 21.7893 5.46957 22 6 22H18C18.5304 22 19.0391 21.7893 19.4142 21.4142C19.7893 21.0391 20 20.5304 20 20V9L13 2Z"></path>
                            </svg>
                            <p>No treatment history found</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@if (showDetailsModal && selectedTreatment != null)
{
    <div class="modal-overlay" @onclick="CloseDetailsModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <div class="modal-header">
                <h2>Treatment Details</h2>
                <button class="btn-close" @onclick="CloseDetailsModal">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>

            <div class="modal-body">
                <div class="detail-group">
                    <label>Treatment</label>
                    <p>@selectedTreatment.Name</p>
                </div>

                <div class="detail-group">
                    <label>Doctor</label>
                    <p>Dr. @selectedTreatment.DoctorName</p>
                </div>

                <div class="detail-group">
                    <label>Date</label>
                    <p>@selectedTreatment.Date.ToString("MMMM dd, yyyy")</p>
                </div>

                <div class="detail-group">
                    <label>Cost</label>
                    <p class="detail-price">₱@selectedTreatment.Price.ToString("N0")</p>
                </div>

                <div class="detail-group">
                    <label>Status</label>
                    <p><span class="status-badge @GetStatusClass(selectedTreatment.Status)">@selectedTreatment.Status</span></p>
                </div>

                @if (selectedTreatment.Rating > 0)
                {
                    <div class="detail-group">
                        <label>Rating</label>
                        <div class="treatment-rating">
                            @for (int i = 1; i <= 5; i++)
                            {
                                <span class="star @(i <= selectedTreatment.Rating ? "filled" : "")">★</span>
                            }
                        </div>
                    </div>
                }

                @if (!string.IsNullOrEmpty(selectedTreatment.Notes))
                {
                    <div class="detail-group">
                        <label>Notes</label>
                        <p>@selectedTreatment.Notes</p>
                    </div>
                }

                @if (!string.IsNullOrEmpty(selectedTreatment.Prescription))
                {
                    <div class="detail-group">
                        <label>Prescription</label>
                        <p>@selectedTreatment.Prescription</p>
                    </div>
                }
            </div>

            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseDetailsModal">Close</button>
            </div>
        </div>
    </div>
}

@code {
    private string patientName = "Patient";
    private bool showSettings = false;
    private bool appointmentReminders = true;

    private List<TreatmentRecord> treatments = new();
    private bool showFilter = false;
    private string filterStatus = "";
    private string filterDoctor = "";
    private DateTime? filterDateFrom = null;
    private DateTime? filterDateTo = null;

    private bool showDetailsModal = false;
    private TreatmentRecord? selectedTreatment = null;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var session = await SessionService.GetCurrentSessionAsync();
            if (session == null)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }
            patientName = session.UserName ?? "Patient";
        }
        catch { patientName = "Patient"; }

        // Sample treatment history data
        treatments = new List<TreatmentRecord>
        {
            new TreatmentRecord
            {
                Id = 1,
                Name = "Initial Consultation",
                DoctorName = "Maria Santos",
                Date = new DateTime(2025, 8, 15),
                Price = 1500,
                Status = "completed",
                Rating = 5,
                Notes = "Comprehensive dental examination completed. Patient shows good oral hygiene.",
                Prescription = "No prescription needed at this time."
            },
            new TreatmentRecord
            {
                Id = 2,
                Name = "X-Ray",
                DoctorName = "Maria Santos",
                Date = new DateTime(2025, 8, 15),
                Price = 800,
                Status = "completed",
                Rating = 5,
                Notes = "Full mouth X-ray taken for comprehensive assessment."
            },
            new TreatmentRecord
            {
                Id = 3,
                Name = "Cavity Filling",
                DoctorName = "Juan Dela Cruz",
                Date = new DateTime(2025, 8, 22),
                Price = 3500,
                Status = "completed",
                Rating = 4,
                Notes = "Composite filling on tooth #14. Patient tolerated procedure well.",
                Prescription = "Take Ibuprofen 400mg as needed for pain. Avoid hard foods for 24 hours."
            },
            new TreatmentRecord
            {
                Id = 4,
                Name = "Teeth Cleaning",
                DoctorName = "Sarah Johnson",
                Date = new DateTime(2025, 9, 10),
                Price = 2500,
                Status = "completed",
                Rating = 5,
                Notes = "Deep cleaning completed. Minimal tartar buildup noted."
            },
            new TreatmentRecord
            {
                Id = 5,
                Name = "Root Canal Treatment",
                DoctorName = "Maria Santos",
                Date = new DateTime(2025, 12, 5),
                Price = 15000,
                Status = "pending",
                Rating = 0,
                Notes = "Scheduled for next month. Pre-treatment consultation completed."
            }
        };
    }

    private void ToggleSettings() => showSettings = !showSettings;
    private void EditProfile() { Navigation.NavigateTo("/patient-profile"); showSettings = false; }
    private void ToggleReminders(ChangeEventArgs e) { appointmentReminders = e.Value is bool b ? b : appointmentReminders; }
    private void MedicalUploads() { Navigation.NavigateTo("/history"); showSettings = false; }
    private void HelpSupport() { Navigation.NavigateTo("/help"); showSettings = false; }
    private void Logout() { Navigation.NavigateTo("/login", true); showSettings = false; }

    private List<TreatmentRecord> GetFilteredTreatments()
    {
        var filtered = treatments.AsEnumerable();

        // Status filter
        if (!string.IsNullOrEmpty(filterStatus))
        {
            filtered = filtered.Where(t => t.Status.Equals(filterStatus, StringComparison.OrdinalIgnoreCase));
        }

        // Doctor filter
        if (!string.IsNullOrEmpty(filterDoctor))
        {
            filtered = filtered.Where(t => t.DoctorName.Equals(filterDoctor, StringComparison.OrdinalIgnoreCase));
        }

        // Date range filter
        if (filterDateFrom.HasValue)
        {
            filtered = filtered.Where(t => t.Date >= filterDateFrom.Value);
        }

        if (filterDateTo.HasValue)
        {
            filtered = filtered.Where(t => t.Date <= filterDateTo.Value);
        }

        return filtered.OrderByDescending(t => t.Date).ToList();
    }

    private string GetStatusClass(string status)
    {
        return status.ToLower() switch
        {
            "completed" => "status-confirmed",
            "pending" => "status-scheduled",
            "cancelled" => "status-cancelled",
            _ => "status-scheduled"
        };
    }

    private string GetIconColorClass(string status)
    {
        return status.ToLower() switch
        {
            "completed" => "icon-green",
            "pending" => "icon-teal",
            "cancelled" => "icon-red",
            _ => "icon-blue"
        };
    }

    private void ToggleFilter()
    {
        showFilter = !showFilter;
    }

    private void ClearFilters()
    {
        filterStatus = "";
        filterDoctor = "";
        filterDateFrom = null;
        filterDateTo = null;
    }

    private void ExportHistory()
    {
        // Implement export functionality (CSV, PDF, etc.)
        Console.WriteLine("Exporting treatment history...");
    }

    private void ViewTreatmentDetails(int treatmentId)
    {
        selectedTreatment = treatments.FirstOrDefault(t => t.Id == treatmentId);
        showDetailsModal = true;
    }

    private void CloseDetailsModal()
    {
        showDetailsModal = false;
        selectedTreatment = null;
    }

    // Model
    public class TreatmentRecord
    {
        public int Id { get; set; }
        public string Name { get; set; } = string.Empty;
        public string DoctorName { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public decimal Price { get; set; }
        public string Status { get; set; } = string.Empty;
        public int Rating { get; set; }
        public string Notes { get; set; } = string.Empty;
        public string Prescription { get; set; } = string.Empty;
    }
}