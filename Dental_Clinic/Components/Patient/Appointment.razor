@page "/appointments"
@using Dental_Clinic.Models
@using Dental_Clinic.Services
@* Removed PatientNavBar usage; using inline navbar from PatientDashboard *@

<link href="css/patientdashboard.css" rel="stylesheet" />
<link href="css/PatientAppointment.css" rel="stylesheet" />

<div class="dashboard-page">
    <PatientNavBar />

    <div class="dashboard-content">
        <div class="dashboard-inner">
    <div class="appointments-content">
        @if (!showBookingModal)
        {
            <div class="page-header">
                <h1 class="page-title">My Appointments</h1>
                <button class="btn-book-appointment" @onclick="BookNewAppointment">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    </svg>
                    Book New Appointment
                </button>
            </div>
            <section class="appointments-section">
                <h2 class="section-title">Upcoming Appointments</h2>
                @if (isLoading)
                {
                    <div class="loading-state"><p>Loading appointments...</p></div>
                }
                else
                {
                    <div class="appointments-list">
                        @if (filteredAppointments.Any())
                        {
                            @foreach (var a in filteredAppointments.Where(a => a.AppointmentDate >= DateTime.Today))
                            {
                                <div class="appointment-card">
                                    <div class="appointment-details">
                                        <h3 class="appointment-title">@a.ServiceName</h3>
                                        <p class="appointment-doctor">@a.DentistName</p>
                                        <div class="appointment-meta">
                                            <div class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <rect x="3" y="4" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
                                                    <path d="M16 2V6M8 2V6M3 10H21" stroke="currentColor" stroke-width="2"/>
                                                </svg>
                                                <span>@a.AppointmentDate.ToString("MMMM dd, yyyy")</span>
                                            </div>
                                            @if (a.StartTime.HasValue)
                                            {
                                                <div class="meta-item">
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                        <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                        <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                    </svg>
                                                    <span>@FormatTime(a.StartTime.Value)</span>
                                                </div>
                                            }
                                            <div class="meta-item">
                                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M21 10C21 17 12 23 12 23C12 23 3 17 3 10C3 7.61305 3.94821 5.32387 5.63604 3.63604C7.32387 1.94821 9.61305 1 12 1C14.3869 1 16.6761 1.94821 18.364 3.63604C20.0518 5.32387 21 7.61305 21 10Z" stroke="currentColor" stroke-width="2"/>
                                                    <circle cx="12" cy="10" r="3" stroke="currentColor" stroke-width="2"/>
                                                </svg>
                                                <span>Main Clinic</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="appointment-actions">
                                        <span class="status-badge status-@((a.Status ?? string.Empty).ToLower())">@(a.Status ?? "")</span>
                                        <button class="btn-reschedule" @onclick="() => RescheduleAppointment(a.AppointmentID)">Reschedule</button>
                                        <button class="btn-reschedule btn-cancel" @onclick="() => OpenCancelModal(a.AppointmentID)">Cancel</button>
                                    </div>
                                </div>
                            }
                        }
                        else
                        {
                            <div class="empty-state"><h4>No appointments scheduled</h4><p>Book your first appointment to get started</p></div>
                        }
                    </div>
                }
            </section>
        }
        else
        {
            <div class="booking-modal-overlay" @onclick="CloseBookingModal">
                <div class="booking-modal" @onclick:stopPropagation="true">
                    <div class="step-indicator">
                        <div class="step @(currentStep >=1 ? "active" : "") @(currentStep >1 ? "completed" : "")">
                            <div class="step-number">1</div>
                            <div class="step-label">Service</div>
                        </div>
                        <div class="step-line @(currentStep >1 ? "completed" : "")"></div>
                        <div class="step @(currentStep >=2 ? "active" : "") @(currentStep >2 ? "completed" : "")">
                            <div class="step-number">2</div>
                            <div class="step-label">Date & Time</div>
                        </div>
                        <div class="step-line @(currentStep >2 ? "completed" : "")"></div>
                        <div class="step @(currentStep >=3 ? "active" : "")">
                            <div class="step-number">3</div>
                            <div class="step-label">Information</div>
                        </div>
                    </div>
                    <div class="booking-body">
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="alert alert-error"><span>@errorMessage</span></div>
                        }
                        @if (!string.IsNullOrEmpty(successMessage))
                        {
                            <div class="alert alert-success"><span>@successMessage</span></div>
                        }

                        @if (currentStep == 1)
                        {
                            <div class="booking-step">
                                <h2 class="booking-title">Choose Your Service</h2>
                                <p class="booking-subtitle">Select a dental service</p>
                                @if (isLoading)
                                {
                                    <div class="loading-state"><p>Loading services...</p></div>
                                }
                                else if (!services.Any())
                                {
                                    <div class="empty-state"><h4>No Services Available</h4><p>Please contact the clinic.</p></div>
                                }
                                else
                                {
                                    <div class="services-grid">
                                        @foreach (var service in services)
                                        {
                                            <div class="service-card @(selectedService?.ServiceID == service.ServiceID ? "selected" : "")" @onclick="() => SelectService(service)">
                                                <h3 class="service-name">@service.ServiceName</h3>
                                                <p class="service-description">@service.Description</p>
                                                <div class="service-info">
                                                    <span class="service-duration">
                                                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                                                            <path d="M12 6V12L16 14" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                                                        </svg>
                                                        @service.Duration mins
                                                    </span>
                                                    <span class="service-type">@service.CategoryName</span>
                                                </div>
                                                <div class="service-price">₱@service.Cost.ToString("N2")</div>
                                                <button class="btn-select-service">Select</button>
                                            </div>
                                        }
                                    </div>
                                }
                            </div>
                        }
                        @if (currentStep == 2)
                        {
                            <div class="booking-step">
                                <h2 class="booking-title">Select Date & Time</h2>
                                <p class="booking-subtitle">Choose a date and time for @selectedService?.ServiceName</p>
                                <div class="datetime-container">
                                    <div class="calendar-section">
                                        <div class="calendar-header">
                                            <button class="btn-calendar-nav" @onclick="PreviousMonth">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M15 18L9 12L15 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                            <span class="calendar-month">@currentMonth.ToString("MMMM yyyy")</span>
                                            <button class="btn-calendar-nav" @onclick="NextMonth">
                                                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                                    <path d="M9 18L15 12L9 6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                                </svg>
                                            </button>
                                        </div>
                                        <div class="calendar-grid">
                                            <div class="calendar-weekdays">
                                                <div class="weekday">Sun</div>
                                                <div class="weekday">Mon</div>
                                                <div class="weekday">Tue</div>
                                                <div class="weekday">Wed</div>
                                                <div class="weekday">Thu</div>
                                                <div class="weekday">Fri</div>
                                                <div class="weekday">Sat</div>
                                            </div>
                                            <div class="calendar-days">
                                                @foreach (var day in GetCalendarDays())
                                                {
                                                    <div class="calendar-day @(day.IsCurrentMonth ? "" : "other-month") @(day.Date == selectedDate ? "selected" : "") @(day.Date < DateTime.Today ? "disabled" : "")" @onclick="() => SelectDate(day.Date)">@day.Date.Day</div>
                                                }
                                            </div>
                                        </div>
                                    </div>
                                    <div class="timeslots-section">
                                        <h3 class="timeslots-title">Available Times</h3>
                                        <p class="timeslots-date">@selectedDate.ToString("dddd, MMMM dd, yyyy")</p>
                                        @if (availableDentists.Count > 1)
                                        {
                                            <div class="dentist-filter">
                                                <label class="filter-label">Filter by Dentist:</label>
                                                <div class="filter-buttons">
                                                    <button class="filter-btn @(selectedDentistFilter == null ? "active" : "")" @onclick="() => FilterByDentist(null)">All</button>
                                                    @foreach (var d in availableDentists)
                                                    {
                                                        <button class="filter-btn @(selectedDentistFilter == d.DentistID ? "active" : "")" @onclick="() => FilterByDentist(d.DentistID)">@((d.DentistName ?? string.Empty).Replace("Dr. ", ""))</button>
                                                    }
                                                </div>
                                            </div>
                                        }
                                        @if (isLoading)
                                        {
                                            <div class="loading-state"><p>Loading available slots...</p></div>
                                        }
                                        else
                                        {
                                            <div class="timeslots-list">
                                                @if (GetFilteredTimeSlots().Any())
                                                {
                                                    @foreach (var slot in GetFilteredTimeSlots())
                                                    {
                                                        <div class="timeslot @(slot.IsAvailable ? "" : "booked") @(selectedTimeSlot?.StartTime == slot.StartTime && selectedTimeSlot?.DentistID == slot.DentistID ? "selected" : "")" @onclick="() => SelectTimeSlot(slot)">
                                                            <div class="timeslot-info">
                                                                <div class="timeslot-time">@slot.FormattedTime</div>
                                                                <div class="timeslot-doctor">@slot.DentistName</div>
                                                            </div>
                                                            <span class="timeslot-status">@(slot.IsAvailable ? "Available" : "Booked")</span>
                                                        </div>
                                                    }
                                                }
                                                else
                                                {
                                                    <p style="text-align:center;color:#64748b;">No available time slots for this date</p>
                                                }
                                            </div>
                                        }
                                    </div>
                                </div>
                            </div>
                        }
                        @if (currentStep == 3)
                        {
                            <div class="booking-step">
                                <h2 class="booking-title">Confirm Your Information</h2>
                                <p class="booking-subtitle">Review and confirm details</p>
                                <div class="confirmation-container">
                                    <div class="appointment-summary">
                                        <h3>Appointment Summary</h3>
                                        <div class="summary-item"><span class="summary-label">Service:</span><span class="summary-value">@selectedService?.ServiceName</span></div>
                                        <div class="summary-item"><span class="summary-label">Date:</span><span class="summary-value">@selectedDate.ToString("MMMM dd, yyyy")</span></div>
                                        <div class="summary-item"><span class="summary-label">Time:</span><span class="summary-value">@selectedTimeSlot?.FormattedTime</span></div>
                                        <div class="summary-item"><span class="summary-label">Dentist:</span><span class="summary-value">@selectedTimeSlot?.DentistName</span></div>
                                        <div class="summary-item"><span class="summary-label">Duration:</span><span class="summary-value">@selectedService?.Duration mins</span></div>
                                        <div class="summary-item total"><span class="summary-label">Price:</span><span class="summary-value">₱@selectedService?.Cost.ToString("N2")</span></div>
                                    </div>
                                    <div class="patient-form">
                                        <h3>Your Information</h3>
                                        <div class="form-group"><label>Full Name</label><input type="text" @bind="patientName" /></div>
                                        <div class="form-group"><label>Email</label><input type="email" @bind="patientEmail" /></div>
                                        <div class="form-group"><label>Phone</label><input type="tel" @bind="patientPhone" /></div>
                                        <div class="form-group"><label>Notes (Optional)</label><textarea rows="3" @bind="appointmentNotes"></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="booking-footer">
                        <button class="btn-secondary" @onclick="HandlePrevious" disabled="@isLoading">@(currentStep == 1 ? "Cancel" : "Previous")</button>
                        <button class="btn-primary" @onclick="HandleNext" disabled="@(!CanProceed() || isLoading)">@(currentStep == 3 ? "Confirm Booking" : "Next")</button>
                    </div>
                </div>
            </div>
        }
        </div>
    </div>
    </div>
</div>

@if (showCancelModal)
{
    <div class="booking-modal-overlay" @onclick="CloseCancelModal">
        <div class="booking-modal" @onclick:stopPropagation="true">
            <div class="booking-body">
                <div class="booking-step">
                    <h2 class="booking-title">Cancel Appointment</h2>
                    <p class="booking-subtitle">Please provide a reason for cancellation</p>
                    @if (!string.IsNullOrEmpty(errorMessage))
                    {
                        <div class="alert alert-error"><span>@errorMessage</span></div>
                    }
                    @if (!string.IsNullOrEmpty(successMessage))
                    {
                        <div class="alert alert-success"><span>@successMessage</span></div>
                    }
                    <div class="form-group">
                        <label>Cancellation Reason</label>
                        <textarea @bind="cancellationReason" rows="4" placeholder="Reason for cancellation"></textarea>
                    </div>
                </div>
            </div>
            <div class="booking-footer">
                <button class="btn-secondary" @onclick="CloseCancelModal">Back</button>
                <button class="btn-primary" @onclick="ConfirmCancelAsync" disabled="@string.IsNullOrWhiteSpace(cancellationReason)">Confirm Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private string FormatTime(TimeSpan time)
    {
        var hours = time.Hours;
        var minutes = time.Minutes;
        var ampm = hours >= 12 ? "PM" : "AM";
        if (hours > 12) hours -= 12;
        if (hours == 0) hours = 12;
        return $"{hours}:{minutes:00} {ampm}";
    }
}
