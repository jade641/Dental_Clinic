@page "/patient-billing"
@using System.Diagnostics
@inject Dental_Clinic.Services.SessionService SessionService
@inject NavigationManager Navigation

<link href="css/patientdashboard.css" rel="stylesheet" />
<link href="css/PatientBilling.css" rel="stylesheet" />

<div class="dashboard-page">
    <PatientNavBar />

    <!-- Main Content Wrapper to match dashboard spacing -->
    <div class="dashboard-content">
        <div class="billing-page">
            <!-- Header Section -->
            <div class="billing-header">
                <h1 class="billing-title">Billing & Payments</h1>
                <button class="btn-make-payment" @onclick="OnMakePayment">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="2" y="5" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                        <path d="M2 9H22" stroke="currentColor" stroke-width="2"/>
                    </svg>
                    Make Payment
                </button>
            </div>

            <!-- Summary Cards Section -->
            <div class="billing-summary">
                <!-- Total Spent Card -->
                <div class="summary-card card-blue">
                    <div class="card-icon blue-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="23 6 13.5 15.5 8.5 10.5 1 18" stroke="currentColor" stroke-width="2"/>
                            <polyline points="17 6 23 6 23 12" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Total Spent</div>
                        <div class="card-amount black">₱@totalSpent.ToString("N0")</div>
                    </div>
                </div>

                <!-- Outstanding Card -->
                <div class="summary-card card-orange">
                    <div class="card-icon orange-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                            <path d="M12 8V12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                            <circle cx="12" cy="16" r="1" fill="currentColor"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Outstanding</div>
                        <div class="card-amount orange">₱@outstanding.ToString("N0")</div>
                    </div>
                </div>

                <!-- Next Payment Card -->
                <div class="summary-card card-green">
                    <div class="card-icon green-icon">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2"/>
                        </svg>
                    </div>
                    <div class="card-content">
                        <div class="card-label">Next Payment</div>
                        <div class="card-amount green">₱@nextPayment.ToString("N0")</div>
                        <div class="card-due-date">Due @nextPaymentDate</div>
                    </div>
                </div>
            </div>

            <!-- Recent Payments Section -->
            <div class="recent-payments-section">
                <h2 class="section-title">Recent Payments</h2>
                
                <div class="payments-list">
                    @if (recentPayments.Any())
                    {
                        @foreach (var payment in recentPayments)
                        {
                            <div class="payment-item">
                                <div class="payment-left">
                                    <div class="payment-check-icon">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <polyline points="20 6 9 17 4 12" stroke="currentColor" stroke-width="2.5"/>
                                        </svg>
                                    </div>
                                    <div class="payment-info">
                                        <div class="payment-title">@payment.Title</div>
                                        <div class="payment-date">@payment.Date.ToString("dd/MM/yyyy")</div>
                                    </div>
                                </div>
                                <div class="payment-right">
                                    <div class="payment-amount">₱@payment.Amount.ToString("N0")</div>
                                    <button class="btn-download" @onclick="() => DownloadReceipt(payment.Id)" title="Download Receipt">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <polyline points="7 10 12 15 17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                            <line x1="12" y1="15" x2="12" y2="3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="empty-state">
                            <svg width="64" height="64" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <rect x="2" y="5" width="20" height="14" rx="2" stroke="currentColor" stroke-width="2"/>
                                <path d="M2 9H22" stroke="currentColor" stroke-width="2"/>
                            </svg>
                            <p>No payment history yet</p>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@code {
    private string patientName = "Patient";

    private decimal totalSpent = 15800;
    private decimal outstanding = 2500;
    private decimal nextPayment = 2500;
    private string nextPaymentDate = "25/09/2025";
    private bool showSettings = false;
    private bool appointmentReminders = true;
    
    private List<Payment> recentPayments = new List<Payment>
    {
        new Payment { Id = 1, Title = "Cavity Filling Payment", Date = new DateTime(2025, 9, 10), Amount = 3500 },
        new Payment { Id = 2, Title = "X-Ray & Consultation", Date = new DateTime(2025, 8, 25), Amount = 2300 }
    };

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var session = await SessionService.GetCurrentSessionAsync();
            if (session == null)
            {
                Navigation.NavigateTo("/login", true);
                return;
            }

            patientName = session.UserName ?? "Patient";
            // TODO: Load actual billing data from database
        }
        catch (Exception ex)
        {
            Debug.WriteLine($"[Billing] Error loading: {ex.Message}");
        }
    }

    private void ToggleSettings() => showSettings = !showSettings;
    private void EditProfile() { Navigation.NavigateTo("/patient-profile"); showSettings = false; }
    private void ToggleReminders(ChangeEventArgs e) { appointmentReminders = e.Value is bool b ? b : appointmentReminders; }
    private void MedicalUploads() { Navigation.NavigateTo("/history"); showSettings = false; }
    private void HelpSupport() { Navigation.NavigateTo("/help"); showSettings = false; }
    private void Logout() { Navigation.NavigateTo("/login", true); showSettings = false; }

    private void OnMakePayment()
    {
        // TODO: Implement payment functionality
        Debug.WriteLine("Make Payment clicked");
    }

    private void DownloadReceipt(int paymentId)
    {
        // TODO: Implement receipt download
        Debug.WriteLine($"Download receipt for payment {paymentId}");
    }

    private class Payment
    {
        public int Id { get; set; }
        public string Title { get; set; } = string.Empty;
        public DateTime Date { get; set; }
        public decimal Amount { get; set; }
    }
}
