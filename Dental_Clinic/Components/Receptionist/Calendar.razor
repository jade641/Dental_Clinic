@page "/receptionist/calendar"
@page "/calendar"
@using Dental_Clinic.Models
@using Dental_Clinic.Services
@using Dental_Clinic.Components.Receptionist
@inject AppointmentService AppointmentService
@inject SessionService SessionService
@inject NavigationManager Navigation

<PageTitle>Appointment Calendar - Receptionist</PageTitle>

<link href="css/receptionistdashboard.css" rel="stylesheet" />
<link href="css/ReceptCalendar.css" rel="stylesheet" />

<div class="receptionist-dashboard">
    <ReceptNavBar />

    <main class="dashboard-main">
        <!-- Calendar Header with Actions -->
        <div class="calendar-page-header">
            <div class="header-left">
                <h2 class="page-main-title">Appointment Calendar</h2>
                <div class="database-status">
                    <span class="status-label">Database:</span>
                    @if (isOffline)
                    {
                        <span class="status-badge offline">OFFLINE (Local)</span>
                        <button class="btn-connect" @onclick="RetryConnection">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6M1 20v-6h6M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                            </svg>
                            Connect Online
                        </button>
                    }
                    else
                    {
                        <span class="status-badge online">ONLINE (Cloud)</span>
                    }
                </div>
            </div>
            <div class="header-actions">
                <input type="date" class="date-input" @bind="selectedDate" @bind:after="OnDateChanged" />
                <button class="btn-refresh" @onclick="LoadDataAsync">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M23 4v6h-6"></path>
                        <path d="M1 20v-6h6"></path>
                        <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                    </svg>
                    Refresh
                </button>
                <button class="btn-new-appointment" @onclick="OpenCreateModal">
                    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                    New Appointment
                </button>
            </div>
        </div>

        <!-- Appointments List Section -->
        <section class="appointments-section">
            <div class="section-header-appointments">
                <div class="section-title-group">
                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                        <line x1="16" y1="2" x2="16" y2="6"></line>
                        <line x1="8" y1="2" x2="8" y2="6"></line>
                        <line x1="3" y1="10" x2="21" y2="10"></line>
                    </svg>
                    <h3>Appointments for @selectedDate.ToString("MMM dd")</h3>
                </div>
                <span class="section-date">@selectedDate.ToString("dddd, MMMM dd, yyyy")</span>
            </div>

            <div class="appointments-list">
                @if (isLoading)
                {
                    <div class="loading-state">
                        <div class="spinner"></div>
                        <p>Loading appointments...</p>
                    </div>
                }
                else if (appointments.Count == 0)
                {
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" width="64" height="64" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                            <line x1="16" y1="2" x2="16" y2="6"></line>
                            <line x1="8" y1="2" x2="8" y2="6"></line>
                            <line x1="3" y1="10" x2="21" y2="10"></line>
                        </svg>
                        <h4>No appointments scheduled</h4>
                        <p>No appointments found for @selectedDate.ToString("MMM dd, yyyy")</p>
                        <p class="mode-info">Current Mode: <strong>@(isOffline ? "Offline" : "Online")</strong></p>
                        @if (!string.IsNullOrEmpty(errorMessage))
                        {
                            <div class="error-message">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <line x1="12" y1="8" x2="12" y2="12"></line>
                                    <line x1="12" y1="16" x2="12.01" y2="16"></line>
                                </svg>
                                <span><strong>Error:</strong> @errorMessage</span>
                            </div>
                        }
                    </div>
                }
                else
                {
                    @foreach (var appt in appointments)
                    {
                        <div class="appointment-card">
                            <!-- Time -->
                            <div class="appointment-time">
                                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                                    stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                    <circle cx="12" cy="12" r="10"></circle>
                                    <polyline points="12 6 12 12 16 14"></polyline>
                                </svg>
                                <span class="time-text">@FormatTime(appt.StartTime)</span>
                                <span class="duration-text">(@GetDuration(appt.StartTime, appt.EndTime) min)</span>
                            </div>

                            <!-- Details -->
                            <div class="appointment-details">
                                <div class="appointment-header">
                                    <h4 class="patient-name">@appt.PatientName</h4>
                                    <span class="status-badge @GetStatusClass(appt.Status)">@appt.Status</span>
                                </div>
                                <p class="appointment-service">@appt.ServiceName</p>
                                <div class="appointment-meta">
                                    <span class="meta-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                        Dr. @appt.DentistName
                                    </span>
                                    <span class="meta-item">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <path
                                                d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z">
                                            </path>
                                        </svg>
                                        @appt.PatientPhone
                                    </span>
                                    @if (!string.IsNullOrEmpty(appt.Notes))
                                    {
                                        <span class="meta-item note-item">
                                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                                                <polyline points="14 2 14 8 20 8"></polyline>
                                                <line x1="16" y1="13" x2="8" y2="13"></line>
                                                <line x1="16" y1="17" x2="8" y2="17"></line>
                                                <polyline points="10 9 9 9 8 9"></polyline>
                                            </svg>
                                            @appt.Notes
                                        </span>
                                    }
                                </div>
                            </div>

                            <!-- Actions -->
                            <div class="appointment-actions">
                                @if (appt.Status == "Scheduled" || appt.Status == "Pending")
                                {
                                    <button class="btn-checkin" @onclick="() => ConfirmAppointment(appt)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                        Check In
                                    </button>
                                }
                                <button class="action-icon-btn" title="Edit" @onclick="() => OpenEditModal(appt)">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                        stroke-linejoin="round">
                                        <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
                                        <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
                                    </svg>
                                </button>
                                @if (appt.Status != "Cancelled")
                                {
                                    <button class="action-icon-btn btn-cancel-appt" title="Cancel"
                                        @onclick="() => CancelAppointment(appt)">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                                            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                                            stroke-linejoin="round">
                                            <line x1="18" y1="6" x2="6" y2="18"></line>
                                            <line x1="6" y1="6" x2="18" y2="18"></line>
                                        </svg>
                                    </button>
                                }
                            </div>
                        </div>
                    }
                }
            </div>
        </section>
    </main>
</div>

@if (showModal)
{
    <div class="modal-backdrop" @onclick="CloseModal">
        <div class="modal-content" @onclick:stopPropagation>
            <div class="modal-header">
                <h2 class="modal-title">@(isEditing ? "Edit Appointment" : "New Appointment")</h2>
                <button class="close-btn" @onclick="CloseModal">×</button>
            </div>
            <div class="modal-body">
                @if (!isEditing)
                {
                    <div class="form-group">
                        <label class="form-label">Patient ID</label>
                        <input type="number" class="form-input" @bind="editingModel.PatientID" placeholder="Enter patient ID" />
                    </div>
                }
                <div class="form-group">
                    <label class="form-label">Dentist</label>
                    <select class="form-input" @bind="editingModel.DentistID">
                        <option value="0">Select Dentist</option>
                        @foreach (var d in dentists)
                        {
                            <option value="@d.DentistID">@d.DentistName</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Service ID</label>
                    <input type="number" class="form-input" @bind="editingModel.ServiceID" placeholder="Enter service ID" />
                </div>
                <div class="form-group">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-input" @bind="editingModel.AppointmentDate" />
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Start Time</label>
                        <input type="time" class="form-input" value="@StartTimeString" @onchange="OnStartTimeChanged" />
                    </div>
                    <div class="form-group">
                        <label class="form-label">End Time</label>
                        <input type="time" class="form-input" value="@EndTimeString" @onchange="OnEndTimeChanged" />
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes (Optional)</label>
                    <textarea class="form-input" rows="3" @bind="editingModel.Notes" placeholder="Add any additional notes..."></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-modal-cancel" @onclick="CloseModal">Cancel</button>
                <button class="btn-modal-save" @onclick="SaveAppointment">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <polyline points="20 6 9 17 4 12"></polyline>
                    </svg>
                    Save Changes
                </button>
            </div>
        </div>
    </div>
}

@if (showSuccessModal)
{
    <div class="modal-backdrop" style="z-index: 2000;" @onclick="CloseSuccessModal">
        <div class="modal-content" style="max-width: 400px; text-align: center; padding: 30px;" @onclick:stopPropagation>
            <div style="margin-bottom: 20px; color: #10b981; display: flex; justify-content: center;">
                <svg width="60" height="60" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path d="M22 11.08V12C21.9988 14.1564 21.3005 16.2547 20.0093 17.9818C18.7182 19.709 16.9033 20.9725 14.8354 21.5839C12.7674 22.1953 10.5573 22.1219 8.53447 21.3746C6.51168 20.6273 4.78465 19.2461 3.61096 17.4371C2.43727 15.628 1.87979 13.4881 2.02168 11.3363C2.16356 9.18455 2.99721 7.13631 4.39828 5.49706C5.79935 3.85781 7.69279 2.71537 9.79619 2.24013C11.8996 1.7649 14.1003 1.98232 16.07 2.85999" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M22 4L12 14.01L9 11.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                </svg>
            </div>
            <h3 style="margin-bottom: 10px; color: #0f172a; font-size: 18px; font-weight: 600;">Success!</h3>
            <p style="color: #64748b; margin-bottom: 20px; font-size: 14px;">@successMessage</p>
            <button class="btn-primary" @onclick="CloseSuccessModal" style="width: 100%; justify-content: center;">OK</button>
        </div>
    </div>
}

@code {
    private List<Appointment> appointments = new();
    private List<DentistAvailability> dentists = new();
    private bool isLoading = true;
    private bool showModal = false;
    private bool isEditing = false;
    private CreateAppointmentModel editingModel = new();
    private int? editingAppointmentId = null;
    private DateTime selectedDate = DateTime.Today;
    private bool isOffline = false;
    
    // Success Modal State
    private bool showSuccessModal = false;
    private string successMessage = "";

    private void CloseSuccessModal()
    {
        showSuccessModal = false;
    }

    // Bridge string bindings for <input type="time"> to TimeSpan
    private string StartTimeString
    {
        get => new DateTime(DateTime.Today.Ticks + editingModel.StartTime.Ticks).ToString("HH:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var ts))
            {
                editingModel.StartTime = ts;
            }
        }
    }

    private string EndTimeString
    {
        get => new DateTime(DateTime.Today.Ticks + editingModel.EndTime.Ticks).ToString("HH:mm");
        set
        {
            if (TimeSpan.TryParse(value, out var ts))
            {
                editingModel.EndTime = ts;
            }
        }
    }

    private void OnStartTimeChanged(ChangeEventArgs e)
    {
        var value = e?.Value?.ToString() ?? string.Empty;
        if (TimeSpan.TryParse(value, out var ts))
        {
            editingModel.StartTime = ts;
        }
    }

    private void OnEndTimeChanged(ChangeEventArgs e)
    {
        var value = e?.Value?.ToString() ?? string.Empty;
        if (TimeSpan.TryParse(value, out var ts))
        {
            editingModel.EndTime = ts;
        }
    }

    protected override async Task OnInitializedAsync()
    {
        try
        {
            var session = await SessionService.GetCurrentSessionAsync();
            if (session?.Role != "Receptionist") { Navigation.NavigateTo("/login"); return; }
            await LoadDataAsync();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
            isLoading = false;
            StateHasChanged();
        }
    }

    private string? errorMessage;

    private async Task LoadDataAsync()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            isOffline = AppointmentService.IsOffline;

            // Get appointments for selected date
            appointments = await AppointmentService.GetAppointmentsInRangeAsync(selectedDate, selectedDate) ?? new();

            if (appointments.Count == 0 && !string.IsNullOrEmpty(AppointmentService.LastError))
            {
                errorMessage = AppointmentService.LastError;
            }

            dentists = await AppointmentService.GetAvailableDentistsAsync(selectedDate) ?? new();
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task OnDateChanged()
    {
        // Guarded refresh after date change
        await LoadDataAsync();
    }

    private async Task RetryConnection()
    {
        isLoading = true;
        AppointmentService.SwitchToOnline();
        await LoadDataAsync();
    }

    private string GetStatusClass(string status) => (status ?? "").ToLower() switch
    {
        "confirmed" => "status-confirmed",
        "in progress" => "status-inprogress",
        "cancelled" => "status-cancelled",
        _ => "status-waiting"
    };

    private string FormatTime(TimeSpan? t)
    {
        if (!t.HasValue) return "";
        return DateTime.Today.Add(t.Value).ToString("h:mm tt");
    }

    private int GetDuration(TimeSpan? start, TimeSpan? end)
    {
        if (!start.HasValue || !end.HasValue) return 0;
        return (int)(end.Value - start.Value).TotalMinutes;
    }

    private void OpenCreateModal()
    {
        isEditing = false;
        editingAppointmentId = null;
        editingModel = new CreateAppointmentModel
        {
            AppointmentDate = selectedDate,
            StartTime = new TimeSpan(9, 0, 0),
            EndTime = new TimeSpan(10, 0, 0)
        };
        showModal = true;
    }

    private void OpenEditModal(Appointment appt)
    {
        isEditing = true;
        editingAppointmentId = appt.AppointmentID;
        editingModel = new CreateAppointmentModel
        {
            PatientID = appt.PatientID,
            DentistID = appt.DentistID ?? 0,
            ServiceID = appt.ServiceID ?? 0,
            AppointmentDate = appt.AppointmentDate,
            StartTime = appt.StartTime ?? TimeSpan.Zero,
            EndTime = appt.EndTime ?? TimeSpan.Zero,
            Notes = appt.Notes,
            PatientName = appt.PatientName
        };
        showModal = true;
    }

    private void CloseModal() => showModal = false;

    private async Task SaveAppointment()
    {
        if (isEditing && editingAppointmentId.HasValue)
        {
            var result = await AppointmentService.UpdateAppointmentAsync(
            editingAppointmentId.Value,
            editingModel.AppointmentDate,
            editingModel.StartTime,
            editingModel.EndTime,
            editingModel.DentistID,
            editingModel.ServiceID,
            editingModel.Notes
            );
            if (result.Success) { CloseModal(); await LoadDataAsync(); }
        }
        else
        {
            var result = await AppointmentService.CreateAppointmentAsync(editingModel);
            if (result.Success) { CloseModal(); await LoadDataAsync(); }
        }
    }

    private async Task ConfirmAppointment(Appointment appt)
    {
        var result = await AppointmentService.ConfirmAppointmentAsync(appt.AppointmentID);
        if (result.Success) 
        {
            await LoadDataAsync();
            successMessage = "Appointment confirmed successfully!";
            showSuccessModal = true;
        }
    }

    private async Task CancelAppointment(Appointment appt)
    {
        var result = await AppointmentService.CancelAppointmentAsync(appt.AppointmentID, 0, "Cancelled by receptionist");
        if (result.Success) 
        {
            await LoadDataAsync();
            successMessage = "Appointment cancelled successfully!";
            showSuccessModal = true;
        }
    }
}