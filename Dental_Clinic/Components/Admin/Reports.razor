@page "/admin/reports"
@using Dental_Clinic.Services
@using Dental_Clinic.Models
@using Microsoft.JSInterop
@inject DatabaseService DbService
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="css/AdminReports.css" />

<AdminNavBar />

<div class="reports-main-content">
    <div class="reports-page-header">
        <h1 class="reports-page-title">Reports & Analytics</h1>
        <button class="btn-generate-report" @onclick="ShowGenerateReportModal">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
            </svg>
            Generate Report
        </button>
    </div>

    <div class="reports-grid">
        @foreach (var report in reports)
        {
            <div class="report-card">
                <div class="report-icon-wrapper @report.Type.ToLower()">
                    <i class="fas @GetReportIcon(report.Type)"></i>
                </div>
                <h3 class="report-title">@report.Title</h3>
                <p class="report-description">@report.Description</p>
                <button class="btn-generate" @onclick="() => DownloadReport(report)">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M12 5V19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M5 12H19" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    </svg>
                    Generate
                </button>
            </div>
        }
    </div>
</div>

@if (showGenerateModal)
{
    <div class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Generate Report</h2>
                <button class="close-btn" @onclick="CloseModal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Report Type</label>
                    <select @bind="selectedReportType">
                        <option value="Financial">Financial Report</option>
                        <option value="Appointments">Appointment Summary</option>
                        <option value="Patients">Patient Demographics</option>
                        <option value="Inventory">Inventory Status</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Format</label>
                    <select @bind="reportFormat">
                        <option value="PDF">PDF Document</option>
                        <option value="CSV">Excel/CSV</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Date Range</label>
                    <div class="date-range">
                        <input type="date" @bind="startDate" />
                        <span>to</span>
                        <input type="date" @bind="endDate" />
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn-secondary" @onclick="CloseModal">Cancel</button>
                <button class="btn-primary-modal" @onclick="GenerateAndDownloadReport">Generate</button>
            </div>
        </div>
    </div>
}

@code {
    private bool showGenerateModal = false;
    private string selectedReportType = "financial";
    private string reportFormat = "pdf";
    private DateTime startDate = DateTime.Now.AddMonths(-1);
    private DateTime endDate = DateTime.Now;

    private List<ReportItem> reports = new();

    protected override void OnInitialized()
    {
        reports = new List<ReportItem>
        {
            new ReportItem
            {
                Type = "financial",
                Icon = "$",
                IconClass = "financial",
                Title = "Financial Report",
                Description = "Revenue, expenses, and profit analysis"
            },
            new ReportItem
            {
                Type = "patient",
                Icon = "",
                IconClass = "patient",
                Title = "Patient Report",
                Description = "Patient demographics and visit patterns"
            },
            new ReportItem
            {
                Type = "service",
                Icon = "",
                IconClass = "service",
                Title = "Service Report",
                Description = "Popular services and performance metrics"
            },
            new ReportItem
            {
                Type = "staff",
                Icon = "",
                IconClass = "staff",
                Title = "Staff Report",
                Description = "Staff performance and productivity"
            },
            new ReportItem
            {
                Type = "audit",
                Icon = "",
                IconClass = "audit",
                Title = "Audit Trail",
                Description = "System activities and user actions"
            }
        };
    }

    private void ShowGenerateReportModal()
    {
        showGenerateModal = true;
    }

    private void CloseModal()
    {
        showGenerateModal = false;
    }

    private async Task GenerateAndDownloadReport()
    {
        try
        {
            var csvContent = await GenerateReport(selectedReportType);
            var fileName = $"{selectedReportType}_Report_{DateTime.Now:yyyyMMdd}.csv";
            
            // Invoke JS to download file
            await JSRuntime.InvokeVoidAsync("downloadFileFromText", fileName, csvContent);
            
            showGenerateModal = false;
            
            // Add to reports list
            reports.Insert(0, new ReportItem 
            { 
                Title = $"{selectedReportType} Report",
                Type = selectedReportType,
                GeneratedDate = DateTime.Now,
                Description = $"Generated on {DateTime.Now:MMM dd, yyyy}"
            });
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error generating report: {ex.Message}");
            await JSRuntime.InvokeVoidAsync("alert", $"Error generating report: {ex.Message}");
        }
    }

    private async Task<string> GenerateReport(string type)
    {
        var sb = new System.Text.StringBuilder();
        
        try 
        {
            switch (type.ToLower())
            {
                case "financial":
                    sb.AppendLine("Date,Description,Amount,Type");
                    var transactions = await DbService.GetTransactionsAsync();
                    if (transactions == null || !transactions.Any())
                    {
                        sb.AppendLine("No transactions found for the selected period.");
                    }
                    else
                    {
                        foreach (var t in transactions)
                        {
                            sb.AppendLine($"{t.Date:yyyy-MM-dd},{EscapeCsv(t.Description)},{t.Amount},{EscapeCsv(t.Type)}");
                        }
                    }
                    break;

                case "appointments":
                    sb.AppendLine("Date,Patient,Dentist,Service,Status");
                    var appointments = await DbService.GetAppointmentsAsync();
                    if (appointments == null || !appointments.Any())
                    {
                        sb.AppendLine("No appointments found.");
                    }
                    else
                    {
                        foreach (var a in appointments)
                        {
                            sb.AppendLine($"{a.Date:yyyy-MM-dd},{EscapeCsv(a.PatientName)},{EscapeCsv(a.DentistName)},{EscapeCsv(a.ServiceName)},{a.Status}");
                        }
                    }
                    break;

                case "patients":
                    sb.AppendLine("Name,Email,Phone,Last Visit");
                    var patients = await DbService.GetPatientsAsync();
                    if (patients == null || !patients.Any())
                    {
                        sb.AppendLine("No patients found.");
                    }
                    else
                    {
                        foreach (var p in patients)
                        {
                            sb.AppendLine($"{EscapeCsv(p.Name)},{EscapeCsv(p.Email)},{EscapeCsv(p.Phone)},{p.LastVisit:yyyy-MM-dd}");
                        }
                    }
                    break;
                    
                default:
                    sb.AppendLine("Report generation not implemented for this type");
                    break;
            }
        }
        catch (Exception ex)
        {
             sb.AppendLine($"Error generating report content: {ex.Message}");
        }
        
        return sb.ToString();
    }

    private string EscapeCsv(string field)
    {
        if (string.IsNullOrEmpty(field))
        {
            return string.Empty;
        }

        var needsQuoting = field.Contains(',') || field.Contains('"') || field.Contains('\n');
        if (!needsQuoting)
        {
            return field;
        }

        var escaped = field.Replace("\"", "\"\"");
        return $"\"{escaped}\"";
    }

    private string GetReportIcon(string type)
    {
        return type.ToLower() switch
        {
            "financial" => "fa-chart-line",
            "appointments" => "fa-calendar-check",
            "patients" => "fa-users",
            "patient" => "fa-users",
            "service" => "fa-briefcase",
            "staff" => "fa-user-shield",
            "inventory" => "fa-boxes",
            "audit" => "fa-shield-alt",
            _ => "fa-file-alt"
        };
    }

    private async Task DownloadReport(ReportItem report)
    {
        // Re-generate report content for download
        var content = await GenerateReport(report.Type);
        var fileName = $"{report.Type}_Report_{report.GeneratedDate:yyyyMMdd}.csv";
        await JSRuntime.InvokeVoidAsync("downloadFileFromText", fileName, content);
    }

    private void DeleteReport(ReportItem report)
    {
        reports.Remove(report);
    }
}
