@page "/admin-analytics"
@using Microsoft.AspNetCore.Components.Routing
@inject NavigationManager Navigation
@inject Dental_Clinic.Services.DatabaseService DatabaseService
@inject IJSRuntime JSRuntime

<link rel="stylesheet" href="css/AdminAnalytics.css">
<link rel="stylesheet" href="css/admindashboard.css" />

<div class="dashboard-page">
    <!-- Top Navigation Bar -->
    <AdminNavBar />

    <!-- Main Content -->
    <main class="dashboard-main main-content">
        <div class="page-header">
            <h2>Analytics Dashboard</h2>
            <div class="header-actions">
                <select class="date-select" @onchange="OnPeriodChanged">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 3 months</option>
                    <option value="365">Last year</option>
                </select>
                <button class="export-btn" @onclick="ExportData">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Weekly Performance (Dual Axis) -->
            <div class="card">
                <h3 class="card-title">Weekly Performance</h3>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <!-- Sales Management (Revenue Trends) -->
            <div class="card">
                <div class="card-header"
                    style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                    <h3 class="card-title">Sales Management</h3>
                    <div class="period-toggle">
                        <button class="btn-toggle @(revenuePeriod == "Daily" ? "active" : "")"
                            @onclick='() => ChangeRevenuePeriod("Daily")'>Daily</button>
                        <button class="btn-toggle @(revenuePeriod == "Monthly" ? "active" : "")"
                            @onclick='() => ChangeRevenuePeriod("Monthly")'>Monthly</button>
                    </div>
                </div>
                <div class="chart-container" style="height: 300px;">
                    <canvas id="revenueChart"></canvas>
                </div>
            </div>

            <!-- Service Distribution (Doughnut) -->
            <div class="card">
                <h3 class="card-title">Service Distribution</h3>
                <div class="chart-container" style="height: 300px; position: relative;">
                    <canvas id="serviceChart"></canvas>
                </div>
            </div>

            <!-- Top Performing Staff -->
            <div class="card">
                <h3 class="card-title">Top Performing Staff</h3>
                <div class="staff-list">
                    @foreach (var staff in topStaff.Select((value, i) => new { i, value }))
                    {
                        <div class="staff-item"
                            style="display: flex; align-items: center; padding: 1rem 0; border-bottom: 1px solid #f3f4f6;">
                            <div class="staff-rank"
                                style="width: 30px; height: 30px; background: @GetRankColor(staff.i); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; margin-right: 1rem;">
                                #@(staff.i + 1)
                            </div>
                            <div class="staff-info" style="flex: 1;">
                                <div class="staff-name" style="font-weight: 600; color: #1f2937;">@staff.value.Name</div>
                                <div class="staff-sub" style="font-size: 0.875rem; color: #6b7280;">
                                    @staff.value.AppointmentsCount appointments</div>
                            </div>
                            <div class="staff-stats" style="text-align: right;">
                                <div class="staff-revenue" style="font-weight: 600; color: #1f2937;">
                                    ₱@staff.value.Revenue.ToString("N0")</div>
                                <div class="staff-rating" style="font-size: 0.875rem; color: #f59e0b;">⭐
                                    @staff.value.Rating.ToString("F1")</div>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>

        <style>
            .dashboard-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 1.5rem;
                margin-top: 1.5rem;
            }

            .card {
                background: white;
                border-radius: 1rem;
                padding: 1.5rem;
                box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            }

            .btn-toggle {
                padding: 0.5rem 1rem;
                border: 1px solid #e5e7eb;
                background: white;
                cursor: pointer;
                border-radius: 0.5rem;
                font-size: 0.875rem;
            }

            .btn-toggle.active {
                background: #3b82f6;
                color: white;
                border-color: #3b82f6;
            }

            .period-toggle {
                display: flex;
                gap: 0.5rem;
            }
        </style>
    </main>
</div>

<script>
    // Ensures Chart.js is loaded before initCharts runs to avoid intermittent JSExceptions on navigation.
    window.ensureChartJs = function () {
        if (window.Chart) {
            return Promise.resolve();
        }
        return new Promise((resolve, reject) => {
            const existing = document.querySelector('script[data-chartjs]');
            if (existing) {
                existing.addEventListener('load', () => resolve());
                existing.addEventListener('error', reject);
                return;
            }
            const script = document.createElement('script');
            script.src = 'https://cdn.jsdelivr.net/npm/chart.js';
            script.async = true;
            script.defer = true;
            script.dataset.chartjs = 'true';
            script.onload = () => resolve();
            script.onerror = reject;
            document.head.appendChild(script);
        });
    };

    window.initCharts = function (weeklyLabels, weeklyPatients, weeklyRevenue, revenueLabels, revenueData, serviceLabels, serviceData, serviceColors) {
        // Weekly Performance Chart (Dual Axis)
        const ctxWeekly = document.getElementById('weeklyChart');
        if (ctxWeekly) {
            if (window.weeklyChartInstance) window.weeklyChartInstance.destroy();
            window.weeklyChartInstance = new Chart(ctxWeekly, {
                type: 'line',
                data: {
                    labels: weeklyLabels,
                    datasets: [
                        {
                            label: 'patients',
                            data: weeklyPatients,
                            borderColor: '#3b82f6',
                            backgroundColor: '#3b82f6',
                            yAxisID: 'y',
                            tension: 0.4
                        },
                        {
                            label: 'revenue',
                            data: weeklyRevenue,
                            borderColor: '#10b981',
                            backgroundColor: '#10b981',
                            yAxisID: 'y1',
                            tension: 0.4
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Patients' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Revenue' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Revenue Chart
        const ctxRev = document.getElementById('revenueChart');
        if (ctxRev) {
            if (window.revenueChartInstance) window.revenueChartInstance.destroy();
            window.revenueChartInstance = new Chart(ctxRev, {
                type: 'line',
                data: {
                    labels: revenueLabels,
                    datasets: [{
                        label: 'Revenue',
                        data: revenueData,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        tension: 0.4,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { beginAtZero: true, grid: { borderDash: [2, 2] } },
                        x: { grid: { display: false } }
                    }
                }
            });
        }

        // Service Chart (Doughnut)
        const ctxSvc = document.getElementById('serviceChart');
        if (ctxSvc) {
            if (window.serviceChartInstance) window.serviceChartInstance.destroy();
            window.serviceChartInstance = new Chart(ctxSvc, {
                type: 'doughnut',
                data: {
                    labels: serviceLabels,
                    datasets: [{
                        data: serviceData,
                        backgroundColor: serviceColors,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: { usePointStyle: true, padding: 20 }
                        }
                    }
                }
            });
        }
    };
</script>

@code {
    private string revenuePeriod = "Monthly";
    private List<Dental_Clinic.Services.DatabaseService.StaffPerformanceModel> topStaff = new();

    // Weekly Performance Data
    private List<string> weeklyLabels = new();
    private List<int> weeklyPatients = new();
    private List<decimal> weeklyRevenue = new();

    // Revenue Trends Data
    private List<string> revenueLabels = new();
    private List<decimal> revenueData = new();

    // Service Distribution Data
    private List<string> serviceLabels = new();
    private List<int> serviceData = new();
    private List<string> serviceColors = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAnalyticsData();
        }
    }

    private async Task LoadAnalyticsData()
    {
        // Load Weekly Performance
        var weekly = await DatabaseService.GetWeeklyPerformanceAsync();
        weeklyLabels = weekly.Select(w => w.Day).ToList();
        weeklyPatients = weekly.Select(w => w.Patients).ToList();
        weeklyRevenue = weekly.Select(w => w.Revenue).ToList();

        // Load Revenue Trends
        var trends = await DatabaseService.GetRevenueTrendsAsync(revenuePeriod);
        revenueLabels = trends.Labels;
        revenueData = trends.Revenue;

        // Load Service Distribution
        var services = await DatabaseService.GetServiceRevenueAsync(30); // Last 30 days for distribution
        serviceLabels = services.Select(s => $"{s.Service} ({s.Percentage}%)").ToList();
        serviceData = services.Select(s => (int)s.Amount).ToList(); // Using Amount for proportion
        serviceColors = services.Select((s, i) => GetColor(i)).ToList();

        // Load Top Staff
        topStaff = await DatabaseService.GetTopPerformingStaffAsync();

        StateHasChanged();
        await JSRuntime.InvokeVoidAsync("ensureChartJs");
        await JSRuntime.InvokeVoidAsync("initCharts",
        weeklyLabels, weeklyPatients, weeklyRevenue,
        revenueLabels, revenueData,
        serviceLabels, serviceData, serviceColors);
    }

    private async Task ChangeRevenuePeriod(string period)
    {
        revenuePeriod = period;
        await LoadAnalyticsData();
    }

    private string GetColor(int index)
    {
        string[] colors = { "#3b82f6", "#10b981", "#06b6d4", "#f59e0b", "#ef4444", "#6b7280", "#8b5cf6", "#ec4899" };
        return colors[index % colors.Length];
    }

    private string GetRankColor(int index)
    {
        return index switch
        {
            0 => "#fbbf24", // Gold
            1 => "#9ca3af", // Silver
            2 => "#b45309", // Bronze
            _ => "#e5e7eb" // Gray
        };
    }

    private void ExportData()
    {
        Console.WriteLine("Exporting data...");
    }

    private void OnPeriodChanged(ChangeEventArgs e)
    {
        // Placeholder if needed
    }
}