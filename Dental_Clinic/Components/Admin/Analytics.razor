@page "/admin-analytics"
@using Microsoft.AspNetCore.Components.Routing
@inject NavigationManager Navigation
@inject Dental_Clinic.Services.DatabaseService DatabaseService

<link rel="stylesheet" href="css/AdminAnalytics.css">
<link rel="stylesheet" href="css/admindashboard.css" />

<div class="dashboard-page">
    <!-- Top Navigation Bar -->
    <AdminNavBar />

    <!-- Main Content -->
    <main class="dashboard-main main-content">
        <div class="page-header">
            <h2>Analytics Dashboard</h2>
            <div class="header-actions">
                <select class="date-select" @onchange="OnPeriodChanged">
                    <option value="7">Last 7 days</option>
                    <option value="30">Last 30 days</option>
                    <option value="90">Last 3 months</option>
                    <option value="365">Last year</option>
                </select>
                <button class="export-btn" @onclick="ExportData">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4" />
                        <polyline points="7 10 12 15 17 10" />
                        <line x1="12" y1="15" x2="12" y2="3" />
                    </svg>
                    Export
                </button>
            </div>
        </div>

        <div class="dashboard-grid">
            <!-- Weekly Performance Chart -->
            <div class="card card-large">
                <h3 class="card-title">Weekly Performance</h3>
                <div class="chart-container">
                    <canvas id="weeklyChart"></canvas>
                </div>
            </div>

            <!-- Service Revenue Breakdown -->
            <div class="card">
                <h3 class="card-title">Service Revenue Breakdown</h3>
                <div class="revenue-list">
                    @foreach (var item in serviceRevenue)
                    {
                        <div class="revenue-item">
                            <div class="revenue-info">
                                <span class="revenue-indicator" style="background-color: @item.Color"></span>
                                <span class="revenue-service">@item.Service</span>
                            </div>
                            <div class="revenue-stats">
                                <span class="revenue-amount">₱@item.Amount.ToString("N0")</span>
                                <span class="revenue-percentage">@item.Percentage% of total</span>
                            </div>
                        </div>
                    }
                </div>
            </div>
        </div>
    </main>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    window.initWeeklyChart = function (labels, patientData, revenueData) {
        try {
            const ctxEl = document.getElementById('weeklyChart');
            if (!ctxEl) return;

            // Destroy existing chart instance if it exists
            if (window.myWeeklyChart) {
                window.myWeeklyChart.destroy();
            }

            const ctx = ctxEl.getContext('2d');
            if (!window.Chart || !ctx) return;

            window.myWeeklyChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels || [],
                    datasets: [
                        {
                            label: 'Patients',
                            data: patientData || [],
                            borderColor: '#10b981',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Revenue',
                            data: revenueData || [],
                            borderColor: '#3b82f6',
                            backgroundColor: 'rgba(59, 130, 246, 0.1)',
                            tension: 0.4,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { legend: { display: true } },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            beginAtZero: true,
                            grid: { drawBorder: false, color: '#f3f4f6' },
                            title: { display: true, text: 'Patients' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            beginAtZero: true,
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Revenue (₱)' }
                        },
                        x: { grid: { display: false } }
                    }
                }
            });
        } catch (e) {
            console.error('initWeeklyChart error', e);
        }
    };
</script>

@code {
    private string selectedPeriod = "7";
    private List<ServiceRevenueItem> serviceRevenue = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadAnalyticsData();
        }
    }

    private async Task LoadAnalyticsData()
    {
        if (int.TryParse(selectedPeriod, out int days))
        {
            // Load Service Revenue
            var services = await DatabaseService.GetServiceRevenueAsync(days);
            serviceRevenue = services.Select((s, index) => new ServiceRevenueItem
            {
                Service = s.Service,
                Amount = (int)s.Amount,
                Percentage = (int)s.Percentage,
                Color = GetColor(index)
            }).ToList();
            StateHasChanged();

            // Load Chart Data
            var (labels, patients, revenue) = await DatabaseService.GetDailyPerformanceAsync(days);
            await JSRuntime.InvokeVoidAsync("initWeeklyChart", labels, patients, revenue);
        }
    }

    private string GetColor(int index)
    {
        string[] colors = { "#3b82f6", "#10b981", "#06b6d4", "#f59e0b", "#ef4444", "#6b7280", "#8b5cf6", "#ec4899" };
        return colors[index % colors.Length];
    }

    private async Task OnPeriodChanged(ChangeEventArgs e)
    {
        selectedPeriod = e.Value?.ToString() ?? "7";
        await LoadAnalyticsData();
    }

    private void ShowNotifications()
    {
        // Show notifications logic
    }

    private void ToggleTheme()
    {
        // Toggle theme logic
    }

    private void ExportData()
    {
        // Export data logic
        Console.WriteLine($"Exporting analytics data for period: {selectedPeriod} days");
    }

    public class ServiceRevenueItem
    {
        public string Service { get; set; } = "";
        public int Amount { get; set; }
        public int Percentage { get; set; }
        public string Color { get; set; } = "";
    }

    [Inject]
    private IJSRuntime JSRuntime { get; set; } = default!;
}