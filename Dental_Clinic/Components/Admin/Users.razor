@page "/admin/users"
@page "/admin-users"
@using Microsoft.AspNetCore.Components.Routing
@using Dental_Clinic.Models
@using Dental_Clinic.Services
@inject NavigationManager Navigation
@inject AuthService AuthService

<link rel="stylesheet" href="css/AdminUsers.css">
<link rel="stylesheet" href="css/admindashboard.css" />

<div class="dashboard-page">
    <!-- Top Navigation Bar -->
    <AdminNavBar />

    <!-- Main Content -->
    <main class="dashboard-main main-content">
        <div class="page-header">
            <div class="header-text">
                <h2>User Management</h2>
                <p class="subtitle">Manage all system users and their permissions</p>
            </div>
            <button class="create-user-btn" @onclick="ShowCreateUserModal">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                    <circle cx="8.5" cy="7" r="4" />
                    <line x1="20" y1="8" x2="20" y2="14" />
                    <line x1="23" y1="11" x2="17" y2="11" />
                </svg>
                Create New User
            </button>
        </div>

        <!-- Stats Cards -->
        <div class="stats-grid">
            <div class="stat-card stat-blue">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                        <circle cx="9" cy="7" r="4" />
                        <path d="M23 21v-2a4 4 0 00-3-3.87m-4-12a4 4 0 010 7.75" />
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Total Users</span>
                    <span class="stat-value">@users.Count</span>
                </div>
            </div>

            <div class="stat-card stat-green">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M16 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2" />
                        <circle cx="8.5" cy="7" r="4" />
                        <line x1="20" y1="8" x2="20" y2="14" />
                        <line x1="23" y1="11" x2="17" y2="11" />
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Active Patients</span>
                    <span class="stat-value">@users.Count(u => u.Role == "Patient")</span>
                </div>
            </div>

            <div class="stat-card stat-purple">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2" />
                        <circle cx="12" cy="7" r="4" />
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Active Dentists</span>
                    <span class="stat-value">@users.Count(u => u.Role == "Dentist")</span>
                </div>
            </div>

            <div class="stat-card stat-orange">
                <div class="stat-icon">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <rect x="2" y="7" width="20" height="14" rx="2" ry="2" />
                        <path d="M16 21V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v16" />
                    </svg>
                </div>
                <div class="stat-content">
                    <span class="stat-label">Active Staff</span>
                    <span class="stat-value">@users.Count(u => u.Role == "Receptionist")</span>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="table-container">
            <div class="table-header">
                <h3>User Management</h3>
                <div class="table-controls">
                    <div class="search-input">
                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2">
                            <circle cx="11" cy="11" r="8" />
                            <path d="M21 21l-4.35-4.35" />
                        </svg>
                        <input type="text" placeholder="Search users..." @bind="tableSearchQuery" @bind:event="oninput">
                    </div>
                    <select class="filter-select" @bind="filterRole">
                        <option value="">All Roles</option>
                        <option value="Patient">Patient</option>
                        <option value="Dentist">Dentist</option>
                        <option value="Receptionist">Receptionist</option>
                        <option value="Admin">Admin</option>
                    </select>
                </div>
            </div>

            <table class="users-table">
                <thead>
                    <tr>
                        <th>User</th>
                        <th>Role</th>
                        <th>Email</th>
                        <th>Phone</th>
                        <th>Status</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var user in FilteredUsers)
                    {
                        <tr>
                            <td>
                                <div class="user-cell">
                                    <div class="user-avatar-text">@GetInitials(user.Name)</div>
                                    <div class="user-details">
                                        <span class="user-name">@user.Name</span>
                                        <span class="user-id">ID: @user.UserId</span>
                                    </div>
                                </div>
                            </td>
                            <td>
                                <span class="role-badge" style="color: @user.RoleColor; background-color: @(user.RoleColor)15;">
                                    @user.Role
                                </span>
                            </td>
                            <td class="email-cell">@user.Email</td>
                            <td class="date-cell">@user.PhoneNumber</td>
                            <td>
                                <span class="status-badge @(user.IsActive ? "status-active" : "status-inactive")">
                                    @(user.IsActive ? "Active" : "Inactive")
                                </span>
                            </td>
                            <td>
                                <div class="action-buttons">
                                    <button class="action-btn" title="Edit" @onclick="() => EditUser(user)">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7" />
                                            <path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z" />
                                        </svg>
                                    </button>
                                    <button class="action-btn @(user.IsActive ? "action-delete" : "action-restore")" 
                                            title="@(user.IsActive ? "Deactivate" : "Activate")" 
                                            @onclick="() => ToggleUserStatus(user.UserId, !user.IsActive)">
                                        @if (user.IsActive)
                                        {
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M18.36 6.64a9 9 0 1 1-12.73 0" />
                                                <line x1="12" y1="2" x2="12" y2="12" />
                                            </svg>
                                        }
                                        else
                                        {
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                                <path d="M23 4v6h-6" />
                                                <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" />
                                            </svg>
                                        }
                                    </button>
                                </div>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        @if (showCreateUserModal)
        {
            <div class="modal-overlay" @onclick="CloseModal">
                <div class="modal-content" @onclick:stopPropagation style="max-width: 600px; max-height: 90vh; overflow-y: auto;">
                    <div class="modal-header">
                        <h3>@(isEditing ? "Edit User" : "Create New User")</h3>
                        <button class="close-btn" @onclick="CloseModal">×</button>
                    </div>
                    <div class="modal-body">
                        <div class="form-row">
                            <div class="form-group">
                                <label>Role</label>
                                <select @bind="newUser.Role" disabled="@isEditing">
                                    <option value="Patient">Patient</option>
                                    <option value="Dentist">Dentist</option>
                                    <option value="Receptionist">Receptionist</option>
                                    <option value="Admin">Admin</option>
                                </select>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>First Name</label>
                                <input type="text" @bind="newUser.FirstName" placeholder="First Name">
                            </div>
                            <div class="form-group">
                                <label>Last Name</label>
                                <input type="text" @bind="newUser.LastName" placeholder="Last Name">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Username</label>
                                <input type="text" @bind="newUser.UserName" placeholder="Username" disabled="@isEditing">
                            </div>
                            <div class="form-group">
                                <label>Email</label>
                                <input type="email" @bind="newUser.Email" placeholder="Email">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Password</label>
                                <input type="password" @bind="newUser.Password" placeholder="@(isEditing ? "Leave blank to keep current" : "Password")">
                            </div>
                            <div class="form-group">
                                <label>Phone Number</label>
                                <input type="text" @bind="newUser.PhoneNumber" placeholder="Phone Number">
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Age</label>
                                <input type="number" @bind="newUser.Age" placeholder="Age">
                            </div>
                            <div class="form-group">
                                <label>Sex</label>
                                <select @bind="newUser.Sex">
                                    <option value="">Select Sex</option>
                                    <option value="Male">Male</option>
                                    <option value="Female">Female</option>
                                </select>
                            </div>
                        </div>

                        @if (newUser.Role == "Dentist")
                        {
                            <div class="form-group">
                                <label>Specialization</label>
                                <input type="text" @bind="newUser.Specialization" placeholder="e.g. Orthodontist">
                            </div>
                        }

                        @if (newUser.Role == "Patient")
                        {
                            <div class="form-group">
                                <label>Birth Date</label>
                                <input type="date" @bind="newUser.BirthDate">
                            </div>
                            <div class="form-group">
                                <label>Address</label>
                                <input type="text" @bind="newUser.Address" placeholder="Full Address">
                            </div>
                            <div class="form-group">
                                <label>Marital Status</label>
                                <select @bind="newUser.MaritalStatus">
                                    <option value="">Select Status</option>
                                    <option value="Single">Single</option>
                                    <option value="Married">Married</option>
                                    <option value="Divorced">Divorced</option>
                                    <option value="Widowed">Widowed</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Medical History</label>
                                <textarea @bind="newUser.MedicalHistory" placeholder="Any medical conditions..."></textarea>
                            </div>
                            <div class="form-row">
                                <div class="form-group">
                                    <label>Insurance Provider</label>
                                    <input type="text" @bind="newUser.InsuranceProvider" placeholder="Provider Name">
                                </div>
                                <div class="form-group">
                                    <label>Policy Number</label>
                                    <input type="text" @bind="newUser.InsurancePolicyNumber" placeholder="Policy #">
                                </div>
                            </div>
                        }
                    </div>
                    <div class="modal-footer">
                        <button class="btn-secondary" @onclick="CloseModal">Cancel</button>
                        <button class="btn-primary" @onclick="SaveUser">@(isEditing ? "Update User" : "Create User")</button>
                    </div>
                </div>
            </div>
        }
    </main>
</div>

@code {
    private string tableSearchQuery = "";
    private string filterRole = "";
    private bool showCreateUserModal = false;
    private bool isEditing = false;
    private int editingUserId = 0;
    private SignUpModel newUser = new SignUpModel();

    private List<UserViewModel> users = new();

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers();
        var uri = Navigation.ToAbsoluteUri(Navigation.Uri);
        if (!string.IsNullOrEmpty(uri.Query))
        {
            var query = uri.Query.TrimStart('?');
            foreach (var part in query.Split('&'))
            {
                var kv = part.Split('=');
                if (kv.Length == 2 && kv[0] == "search")
                {
                    tableSearchQuery = Uri.UnescapeDataString(kv[1]);
                    break;
                }
            }
        }
    }

    private async Task LoadUsers()
    {
        var dbUsers = await AuthService.GetAllUsersAsync();
        users = dbUsers.Select(u => new UserViewModel
        {
            UserId = u.UserID,
            Name = u.FullName,
            Role = u.RoleName,
            RoleColor = GetRoleColor(u.RoleName),
            Email = u.Email,
            PhoneNumber = u.PhoneNumber,
            IsActive = u.IsActive
        }).ToList();
    }

    private IEnumerable<UserViewModel> FilteredUsers =>
        users.Where(u =>
            (string.IsNullOrEmpty(tableSearchQuery) || u.Name.Contains(tableSearchQuery, StringComparison.OrdinalIgnoreCase) || u.Email.Contains(tableSearchQuery, StringComparison.OrdinalIgnoreCase)) &&
            (string.IsNullOrEmpty(filterRole) || u.Role == filterRole)
        );

    private void ShowCreateUserModal() 
    {
        isEditing = false;
        newUser = new SignUpModel { Role = "Patient" }; // Reset form
        showCreateUserModal = true;
    }
    
    private void EditUser(UserViewModel user)
    {
        isEditing = true;
        editingUserId = user.UserId;
        
        // Populate form with user data
        // Note: In a real app, you might want to fetch full details from DB if the list view is partial
        // For now, we'll populate what we have and split the name
        var names = user.Name.Split(' ');
        newUser = new SignUpModel
        {
            Role = user.Role,
            FirstName = names.Length > 0 ? names[0] : "",
            LastName = names.Length > 1 ? string.Join(" ", names.Skip(1)) : "",
            Email = user.Email,
            PhoneNumber = user.PhoneNumber,
            UserName = "ExistingUser", // Placeholder, disabled in edit
            Password = "" // Empty for edit unless changed
        };
        
        showCreateUserModal = true;
    }

    private async Task ToggleUserStatus(int userId, bool newStatus)
    {
        var result = await AuthService.ToggleUserStatusAsync(userId, newStatus);
        if (result.Success)
        {
            await LoadUsers();
        }
        else
        {
            Console.WriteLine($"Error: {result.Message}");
        }
    }
    
    private void CloseModal() => showCreateUserModal = false;

    private void ViewUser(int userId) => Console.WriteLine($"Viewing user: {userId}");

    private async Task SaveUser()
    {
        if (isEditing)
        {
            var result = await AuthService.UpdateUserAsync(newUser, editingUserId);
            if (result.Success)
            {
                await LoadUsers();
                CloseModal();
            }
            else
            {
                Console.WriteLine($"Error: {result.Message}");
            }
        }
        else
        {
            await CreateUser();
        }
    }

    private async Task CreateUser()
    {
        // Basic validation
        if (string.IsNullOrWhiteSpace(newUser.UserName) || string.IsNullOrWhiteSpace(newUser.Password) || string.IsNullOrWhiteSpace(newUser.Email))
        {
            // Show error (alert or toast)
            return;
        }

        var result = await AuthService.RegisterAsync(newUser);
        if (result.Success)
        {
            await LoadUsers();
            CloseModal();
        }
        else
        {
            // Show error
            Console.WriteLine($"Error: {result.Message}");
        }
    }

    private string GetRoleColor(string role)
    {
        return role switch
        {
            "Patient" => "#6b7280",
            "Dentist" => "#3b82f6",
            "Receptionist" => "#10b981",
            "Admin" => "#a855f7",
            _ => "#6b7280"
        };
    }

    private string GetInitials(string name)
    {
        if (string.IsNullOrEmpty(name)) return "??";
        var parts = name.Split(' ', StringSplitOptions.RemoveEmptyEntries);
        if (parts.Length >= 2) return $"{parts[0][0]}{parts[1][0]}";
        if (parts.Length == 1) return $"{parts[0][0]}";
        return "??";
    }

    public class UserViewModel
    {
        public int UserId { get; set; }
        public string Name { get; set; } = "";
        public string Role { get; set; } = "";
        public string RoleColor { get; set; } = "";
        public string Email { get; set; } = "";
        public string PhoneNumber { get; set; } = "";
        public bool IsActive { get; set; }
    }
}